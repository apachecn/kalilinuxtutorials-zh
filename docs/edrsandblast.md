# edr blaster:ä¸€ç§å·¥å…·ï¼Œå®ƒå°†æ˜“å—æ”»å‡»çš„ç­¾åé©±åŠ¨ç¨‹åºæ­¦å™¨åŒ–ï¼Œä»¥ç»•è¿‡ EDR æ£€æµ‹å’Œ LSASS ä¿æŠ¤

> åŸæ–‡ï¼š<https://kalilinuxtutorials.com/edrsandblast/>

[![](img/3711a26e8e540be137164798f362ad17.png)](https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEis_yOn1e7YGn9RW3PLi0WLWCk14vFXkxVX_AzaQul9EivkoleX1A3USFk-KAecfpaK67268iDAMNKcSDOKKDk-v1Jmlz2HeGPPQnVaD-UjcJgskpUXIKP4CZbCyNuLWFk9ExY9LyjyvL-nyw4gg_XKuqKjrZLBRK4nY067CFLRnxqMx_len7iJdPqm/s728/mimikatzremoved.png)

`**EDRSandBlast**`æ˜¯ç”¨ **`C`** ç¼–å†™çš„å·¥å…·ï¼Œå°†æ˜“å—æ”»å‡»çš„ç­¾åé©±åŠ¨ç¨‹åºæ­¦å™¨åŒ–ï¼Œä»¥ç»•è¿‡ EDR æ£€æµ‹(å†…æ ¸å›è°ƒå’Œ`**ETW TI**`æä¾›è€…)å’Œ`**LSASS**`ä¿æŠ¤ã€‚å¤šç”¨æˆ·åŒºåŸŸè„±é’©æŠ€æœ¯ä¹Ÿè¢«å®ç°ä»¥é€ƒé¿ç”¨æˆ·åŒºåŸŸç›‘æ§ã€‚

è‡ªå‘å¸ƒä¹‹æ—¥èµ·ï¼Œç”¨æˆ·åŸŸ(`**--usermode**`)å’Œå†…æ ¸åŸŸ(`**--kernelmode**`)æŠ€æœ¯çš„ç»„åˆè¢«ç”¨äºåœ¨ EDR å®¡æŸ¥ä¸‹è½¬å‚¨`**LSASS**`å†…å­˜ï¼Œè€Œä¸ä¼šè¢«é˜»æ­¢ï¼Œä¹Ÿä¸ä¼šåœ¨äº§å“(äº‘)æ§åˆ¶å°ä¸­ç”Ÿæˆä¸â€œæ“ä½œç³»ç»Ÿå‡­è¯è½¬å‚¨â€ç›¸å…³çš„äº‹ä»¶ã€‚æµ‹è¯•åœ¨ 3 ç§ä¸åŒçš„ EDR äº§å“ä¸Šè¿›è¡Œï¼Œå¹¶ä¸”åœ¨æ¯ç§æƒ…å†µä¸‹éƒ½æˆåŠŸã€‚

## æè¿°

### é€šè¿‡å†…æ ¸å›è°ƒç§»é™¤ EDR ç»•è¿‡

EDR äº§å“åœ¨ Windows ä¸Šä½¿ç”¨å†…æ ¸å›è°ƒï¼Œç”±å†…æ ¸é€šçŸ¥ç³»ç»Ÿæ´»åŠ¨ï¼Œæ¯”å¦‚è¿›ç¨‹å’Œçº¿ç¨‹çš„åˆ›å»ºä»¥åŠé•œåƒçš„åŠ è½½( **`exe` / `DLL`** )ã€‚

å†…æ ¸å›è°ƒæ˜¯ä½¿ç”¨è®¸å¤šæ–‡æ¡£åŒ–çš„ API(**`nt!PsSetCreateProcessNotifyRoutine`ã€`nt!PsSetCreateThreadNotifyRoutine`** ç­‰)ä»ç”¨æˆ·å±‚é¢å®šä¹‰çš„ã€‚).ç”¨æˆ·åŸŸ API å°†é©±åŠ¨ç¨‹åºæä¾›çš„å›è°ƒä¾‹ç¨‹æ·»åŠ åˆ°å†…æ ¸ç©ºé—´ä¸­æœªè®°å½•çš„ä¾‹ç¨‹æ•°ç»„ä¸­:

*   `**PspCreateProcessNotifyRoutine**`ç”¨äºæµç¨‹åˆ›å»º
*   `**PspCreateThreadNotifyRoutine**`ç”¨äºèºçº¹åˆ›å»º
*   `**PspLoadImageNotifyRoutine**`ç”¨äºå›¾åƒåŠ è½½

`**EDRSandBlast**`æšä¸¾é‚£äº›æ•°ç»„ä¸­å®šä¹‰çš„ä¾‹ç¨‹ï¼Œå¹¶åˆ é™¤ä»»ä½•é“¾æ¥åˆ°é¢„å®šä¹‰çš„ EDR é©±åŠ¨ç¨‹åºåˆ—è¡¨çš„å›è°ƒä¾‹ç¨‹(æ¥è‡ªåˆ†é…çš„è¿‡æ»¤å™¨é«˜åº¦çš„è¶…è¿‡ 1000ï¼Œ000 ä¸ªå®‰å…¨äº§å“çš„é©±åŠ¨ç¨‹åº)ã€‚é€šè¿‡åˆ©ç”¨`**Micro-Star MSI Afterburner**`é©±åŠ¨ç¨‹åº(`**CVE-2019-16098**`)çš„ä»»æ„å†…æ ¸å†…å­˜è¯»/å†™æ¼æ´ï¼Œå¯ä»¥å®ç°æšä¸¾å’Œåˆ é™¤ã€‚æšä¸¾å’Œåˆ é™¤ä»£ç å¾ˆå¤§ç¨‹åº¦ä¸Šæ˜¯å— br-sn çš„ CheekyBlinder é¡¹ç›®çš„å¯å‘ã€‚

å¯¹äºè¶…è¿‡ 350 ä¸ªç‰ˆæœ¬çš„ Windows å†…æ ¸`**ntoskrnl.exe**`ï¼Œä¸Šè¿°æ•°ç»„çš„åç§»é‡è¢«ç¡¬ç¼–ç åœ¨`**NtoskrnlOffsets.csv**`æ–‡ä»¶ä¸­ã€‚é€‰æ‹©ä½¿ç”¨ç¡¬ç¼–ç çš„åç§»é‡è€Œä¸æ˜¯æ¨¡å¼æœç´¢æ˜¯åˆç†çš„ï¼Œå› ä¸ºè´Ÿè´£å†…æ ¸å›è°ƒæ·»åŠ /ç§»é™¤çš„æœªè®°å½•çš„ API å¯èƒ½ä¼šå‘ç”Ÿå˜åŒ–ï¼Œå¹¶ä¸”ä»»ä½•åœ¨é”™è¯¯åœ°å€å†™å…¥å†…æ ¸å†…å­˜çš„å°è¯•éƒ½å¯èƒ½(å¹¶ä¸”ç»å¸¸ä¼š)å¯¼è‡´ **`Bug Check` ( `Blue`** `**Screen of Death**`)ã€‚æœ‰å…³å¦‚ä½•æ”¶é›†å¤±è°ƒçš„æ›´å¤šä¿¡æ¯ï¼Œè¯·å‚è€ƒå¤±è°ƒéƒ¨åˆ†ã€‚

### é€šè¿‡åœç”¨ ETW å¾®è½¯è§†çª—å¨èƒæƒ…æŠ¥æä¾›å•†ç»•è¿‡ EDR

`**ETW Microsoft-Windows-Threat-Intelligence**` provider è®°å½•ä¸€äº›å¸¸ç”¨çš„ Windows API è¢«æ¶æ„ä½¿ç”¨çš„æ•°æ®ã€‚è¿™åŒ…æ‹¬ç”±`**nt!NtReadVirtualMemory**`è°ƒç”¨çš„`**nt!MiReadWriteVirtualMemory**` API(ç”¨äºè½¬å‚¨`**LSASS**`å†…å­˜)å’Œç”±`**nt!EtwTiLogReadWriteVm**`å‡½æ•°ç›‘æ§ã€‚

EDR äº§å“å¯ä»¥é€šè¿‡åˆ†åˆ«ä½œä¸º`**SERVICE_LAUNCH_PROTECTED_ANTIMALWARE_LIGH**T`æˆ–**ã€**è¿è¡Œå¹¶ä¸`**Early Launch Anti Malware (ELAM)**`é©±åŠ¨ç¨‹åºç›¸å…³è”çš„æœåŠ¡æˆ–è¿›ç¨‹ï¼Œæ¥ä½¿ç”¨`**ETW TI**`æä¾›è€…ç”Ÿæˆçš„æ—¥å¿—ã€‚

æ­£å¦‚`**slaeryan**`åœ¨ä¸€ç¯‡`**CNO Development Labs**`åšå®¢æ–‡ç« ä¸­æ‰€å‘è¡¨çš„ï¼Œ **`ETW TI`** æä¾›è€…å¯ä»¥é€šè¿‡åœ¨å†…æ ¸å†…å­˜ä¸­å°†å…¶`**ProviderEnableInfo**`å±æ€§ä¿®è¡¥ä¸º`**0x0**`æ¥å®Œå…¨ç¦ç”¨ã€‚å…³äºè¿™é¡¹æŠ€æœ¯çš„æ›´å¤šä¿¡æ¯ï¼Œè¯·å‚è€ƒå‰é¢æåˆ°çš„åšå®¢æ–‡ç« ã€‚

ç±»ä¼¼äºå†…æ ¸å›è°ƒç§»é™¤ï¼Œå¿…è¦çš„`**ntoskrnl.exe**`åç§»é‡( **`nt!EtwThreatIntProvRegHandleOffset`ã€`_ETW_REG_ENTRY`çš„`GuidEntry`** å’Œ **`_ETW_GUID_ENTRY`çš„`ProviderEnableInfo`** )è¢«ç¡¬ç¼–ç åœ¨å¤šä¸ª Windows å†…æ ¸ç‰ˆæœ¬çš„`**NtoskrnlOffsets.csv**`æ–‡ä»¶ä¸­ã€‚

### é€šè¿‡ç”¨æˆ·åŒºæŒ‚æ¥æ—è·¯çš„ EDR æ—è·¯

#### ç”¨æˆ·åŒºæŒ‚é’©çš„å·¥ä½œåŸç†

ä¸ºäº†æ–¹ä¾¿åœ°ç›‘æ§è¿›ç¨‹æ‰§è¡Œçš„åŠ¨ä½œï¼ŒEDR äº§å“ç»å¸¸éƒ¨ç½²ä¸€ç§å«åš*ç”¨æˆ·åŸŸæŒ‚é’©*çš„æœºåˆ¶ã€‚é¦–å…ˆï¼ŒEDR äº§å“æ³¨å†Œä¸€ä¸ªå†…æ ¸å›è°ƒå‡½æ•°(é€šå¸¸æ˜¯*é•œåƒåŠ è½½*æˆ–*è¿›ç¨‹åˆ›å»º*å›è°ƒå‡½æ•°ï¼Œè§ä¸Š)ï¼Œå…è®¸å®ƒä»¬åœ¨æ¯ä¸ªè¿›ç¨‹å¯åŠ¨æ—¶å¾—åˆ°é€šçŸ¥ã€‚

å½“ä¸€ä¸ªè¿›ç¨‹è¢« Windows åŠ è½½æ—¶ï¼Œåœ¨å®ƒå®é™…å¯åŠ¨ä¹‹å‰ï¼ŒEDR èƒ½å¤Ÿå°†ä¸€äº›è‡ªå®šä¹‰ DLL æ³¨å…¥åˆ°åŒ…å«å…¶ç›‘æ§é€»è¾‘çš„è¿›ç¨‹åœ°å€ç©ºé—´ä¸­ã€‚åœ¨åŠ è½½æ—¶ï¼Œè¿™ä¸ª DLL åœ¨æ¯ä¸ªç”± EDR ç›‘æ§çš„å‡½æ•°çš„å¼€å§‹æ³¨å…¥"*é’©å­*"ã€‚åœ¨è¿è¡Œæ—¶ï¼Œå½“è¢«ç›‘è§†çš„è¿›ç¨‹è°ƒç”¨è¢«ç›‘è§†çš„å‡½æ•°æ—¶ï¼Œè¿™äº›é’©å­å°†æ§åˆ¶æµé‡å®šå‘åˆ° EDR DLL ä¸­çš„ä¸€äº›ç›‘ç£ä»£ç ï¼Œè¿™å…è®¸å®ƒæ£€æŸ¥è¿™äº›è°ƒç”¨çš„å‚æ•°å’Œè¿”å›å€¼ã€‚

å¤§å¤šæ•°æ—¶å€™ï¼Œè¢«ç›‘æ§çš„å‡½æ•°éƒ½æ˜¯ç³»ç»Ÿè°ƒç”¨(å¦‚ **`NtReadVirtualMemory`ã€`NtOpenProcess`** ç­‰)ã€‚)ï¼Œå…¶å®ç°ä½äº`**ntdll.dll**`ã€‚æ‹¦æˆªå¯¹`**Nt***`å‡½æ•°çš„è°ƒç”¨å…è®¸äº§å“å°½å¯èƒ½æ¥è¿‘ç”¨æˆ·åŸŸ/å†…æ ¸åŸŸè¾¹ç•Œ(åŒæ—¶ä¿æŒåœ¨ç”¨æˆ·åŸŸå†…)ï¼Œä½†æ˜¯æ¥è‡ªä¸€äº›æ›´é«˜çº§åˆ«çš„ dll çš„å‡½æ•°ä¹Ÿå¯èƒ½è¢«ç›‘æ§ã€‚

ä»¥ä¸‹æ˜¯ä½¿ç”¨ EDR äº§å“å‰åç›¸åŒåŠŸèƒ½çš„ç¤ºä¾‹:

**ntprotectivirtualmemory proc near
mov r10ï¼Œrcx
mov eaxï¼Œ50h
ptr å­—èŠ‚æµ‹è¯• ds:7FFE0308hï¼Œ1
jnz short loc _ 18009 D1 E5
sys all
retn
loc _ 18009 D1 E5:** 

**NtProtectVirtualMemory proc é™„è¿‘
jmp sub _ 7 ffc 74490298ï¼›â€“>â€œé’©å­â€ï¼Œè·³è½¬åˆ° EDR åˆ†æå‡½æ•°
int 3ï¼›è¢«è¦†ç›–çš„æŒ‡ä»¤
int 3ï¼›è¢«è¦†ç›–çš„æŒ‡ä»¤
int 3ï¼›è¦†å†™æŒ‡ä»¤
æµ‹è¯• byte_7FFE0308ï¼Œ1ï¼›<â€“åˆ†æåæ‰§è¡Œåœ¨æ­¤æ¢å¤
jnz short loc _ 7 ffcb 44 ad1e 5
syscall
retn
loc _ 7 ffcb 44 ad1e 5:
int 2Eh
retn
NtProtectVirtualMemory endp**

#### é’©å­æ£€æµ‹

ç”¨æˆ·åŒºæŒ‚é’©çš„â€œå¼±ç‚¹â€æ˜¯ä½äºç”¨æˆ·åŒºå†…å­˜ä¸­ï¼Œè¿™æ„å‘³ç€å®ƒä»¬å¯ä»¥è¢«æ­£åœ¨å®¡æŸ¥çš„è¿›ç¨‹ç›´æ¥è§‚å¯Ÿå’Œä¿®æ”¹ã€‚è¦è‡ªåŠ¨æ£€æµ‹è¿›ç¨‹åœ°å€ç©ºé—´ä¸­çš„æŒ‚é’©ï¼Œä¸»è¦æ€æƒ³æ˜¯æ¯”è¾ƒç£ç›˜ä¸Šçš„åŸå§‹ DLL å’Œé©»ç•™åœ¨å†…å­˜ä¸­çš„åº“ä¹‹é—´çš„å·®å¼‚ï¼Œè¿™äº›å·®å¼‚å¯èƒ½å·²è¢« EDR æ”¹å˜ã€‚ä¸ºäº†è¿›è¡Œè¿™ç§æ¯”è¾ƒï¼Œedr blassam éµå¾ªä»¥ä¸‹æ­¥éª¤:

*   ç”±äºä½äº`**PEB**`ä¸­çš„`**InLoadOrderModuleList**`ï¼Œæ‰€æœ‰åŠ è½½çš„ dll çš„åˆ—è¡¨è¢«æšä¸¾(ä»¥é¿å…è°ƒç”¨ä»»ä½•å¯èƒ½è¢«ç›‘è§†å’Œå¯ç–‘çš„ API)
*   å¯¹äºæ¯ä¸ªåŠ è½½çš„ DLLï¼Œå®ƒåœ¨ç£ç›˜ä¸Šçš„å†…å®¹è¢«è¯»å–å¹¶ä¸”å®ƒçš„å¤´è¢«è§£æã€‚é©»ç•™åœ¨å­˜å‚¨å™¨ä¸­çš„ç›¸åº”åº“ä¹Ÿè¢«è§£æä»¥è¯†åˆ«éƒ¨åˆ†ã€å¯¼å‡ºç­‰ã€‚
*   é€šè¿‡è€ƒè™‘ç›¸åº”åŠ è½½åº“çš„åŸºå€ï¼ŒDLL çš„é‡å®šä½è¢«è§£æå’Œåº”ç”¨ã€‚è¿™å…è®¸å†…å­˜åº“å’Œæºè‡ªç£ç›˜çš„ DLL çš„å†…å®¹å…·æœ‰å®Œå…¨ç›¸åŒçš„å†…å®¹(åœ¨åº”ç”¨é‡å®šä½çš„éƒ¨åˆ†)ï¼Œä»è€Œä½¿å¾—æ¯”è¾ƒå¯é ã€‚
*   æšä¸¾å¯¼å‡ºçš„å‡½æ•°ï¼Œå¹¶æ¯”è¾ƒâ€œå†…å­˜ä¸­â€å’Œâ€œç£ç›˜ä¸Šâ€ç‰ˆæœ¬çš„ç¬¬ä¸€ä¸ªå­—èŠ‚ã€‚ä»»ä½•å·®å¼‚éƒ½è¡¨æ˜åœ¨åŠ è½½ DLL åè¿›è¡Œäº†æ›´æ”¹ï¼Œå› æ­¤å¾ˆå¯èƒ½æ˜¯ EDR æŒ‚é’©ã€‚

æ³¨æ„:è¿™ä¸ªè¿‡ç¨‹å¯ä»¥æ¨å¹¿åˆ°æŸ¥æ‰¾ä¸å¯å†™éƒ¨åˆ†çš„ä»»ä½•åœ°æ–¹çš„å·®å¼‚ï¼Œè€Œä¸ä»…ä»…æ˜¯åœ¨å¯¼å‡ºå‡½æ•°çš„å¼€å§‹å¤„ï¼Œä¾‹å¦‚ï¼Œå¦‚æœ EDR äº§å“åœ¨å‡½æ•°ä¸­é—´å¼€å§‹åº”ç”¨é’©å­ğŸ™‚å› æ­¤ä¸è¢«å·¥å…·ä½¿ç”¨ï¼Œè¿™å·²ç»åœ¨`**findDiffsInNonWritableSections**`ä¸­å®ç°ã€‚

ä¸ºäº†ç»•è¿‡è¿™äº›é’©å­æ‰§è¡Œçš„ç›‘æ§ï¼Œå¯ä»¥ä½¿ç”¨å¤šç§æŠ€æœ¯ï¼Œæ¯ç§æŠ€æœ¯éƒ½æœ‰ä¼˜ç‚¹å’Œç¼ºç‚¹ã€‚

#### æŒ‚é’©æ—è·¯ä½¿ç”¨â€¦è„±é’©

ç»•è¿‡åŸºäºé’©å­çš„ç›‘æ§çš„æœ€ç›´è§‚çš„æ–¹æ³•æ˜¯ç§»é™¤é’©å­ã€‚å› ä¸ºé’©å­å­˜åœ¨äºè¿›ç¨‹æœ¬èº«å¯ä»¥åˆ°è¾¾çš„å†…å­˜ä¸­ï¼Œæ‰€ä»¥è¦ç§»é™¤é’©å­ï¼Œè¿›ç¨‹å¯ä»¥ç®€å•åœ°:

*   æ”¹å˜æŒ‚é’©æ‰€åœ¨é¡µé¢çš„æƒé™(RX -> RWX æˆ– RW)
*   ç”±äºç£ç›˜ä¸Šçš„ DLL å†…å®¹ï¼Œå†™å…¥å·²çŸ¥çš„åŸå§‹å­—èŠ‚
*   å°†æƒé™æ”¹å› RX

è¿™ç§æ–¹æ³•ç›¸å½“ç®€å•ï¼Œå¯ä»¥ç”¨æ¥ä¸€æ¬¡åˆ é™¤æ‰€æœ‰æ£€æµ‹åˆ°çš„é’©å­ã€‚ç”±æ”»å‡»æ€§å·¥å…·åœ¨å¼€å§‹æ—¶æ‰§è¡Œï¼Œè¿™å…è®¸ä»£ç çš„å…¶ä½™éƒ¨åˆ†å®Œå…¨ä¸çŸ¥é“æŒ‚é’©æœºåˆ¶ï¼Œå¹¶åœ¨ä¸å—ç›‘æ§çš„æƒ…å†µä¸‹æ­£å¸¸æ‰§è¡Œã€‚

ç„¶è€Œï¼Œå®ƒæœ‰ä¸¤ä¸ªä¸»è¦ç¼ºç‚¹ã€‚EDR å¯èƒ½æ­£åœ¨ç›‘æ§`NtProtectVirtualMemory`çš„ä½¿ç”¨ï¼Œæ‰€ä»¥ç”¨å®ƒæ¥æ”¹å˜å®‰è£…äº†é’©å­çš„é¡µé¢çš„æƒé™(è‡³å°‘åœ¨æ¦‚å¿µä¸Š)æ˜¯ä¸ªåä¸»æ„ã€‚æ­¤å¤–ï¼Œå¦‚æœä¸€ä¸ªçº¿ç¨‹ç”± EDR æ‰§è¡Œï¼Œå¹¶å®šæœŸæ£€æŸ¥æŒ‚é’©çš„å®Œæ•´æ€§ï¼Œè¿™ä¹Ÿå¯èƒ½è§¦å‘ä¸€äº›æ£€æµ‹ã€‚

å…·ä½“å®ç°è¯·æŸ¥çœ‹`**unhook_method**`ä¸º **`UNHOOK_WITH_NTPROTECTVIRTUALMEMORY`æ—¶`**unhook()**`å‡½æ•°çš„ä»£ç è·¯å¾„ã€‚**

**é‡è¦æç¤º:ä¸ºç®€å•èµ·è§ï¼Œè¯¥æŠ€æœ¯åœ¨ edr blaster ä¸­å®ç°ï¼Œä½œä¸ºç”¨äº*å±•ç¤º*å…¶ä»–æ—è·¯æŠ€æœ¯çš„åŸºç¡€æŠ€æœ¯ï¼›å®ƒä»¬ä¸­çš„æ¯ä¸€ä¸ªéƒ½æ¼”ç¤ºäº†å¦‚ä½•è·å¾—ä¸€ä¸ªä¸å—ç›‘æ§çš„`NtProtectVirtualMemory`ç‰ˆæœ¬ï¼Œä½†æ˜¯ä¹‹åæ‰§è¡Œç›¸åŒçš„æ“ä½œ(è§£å¼€ä¸€ä¸ªç‰¹å®šçš„é’©å­)ã€‚**

#### ä½¿ç”¨å®šåˆ¶çš„è¹¦åºŠé’©ä½æ—è·¯

è¦ç»•è¿‡ä¸€ä¸ªç‰¹å®šçš„é’©å­ï¼Œå¯ä»¥ç®€å•åœ°â€œè·³è¿‡â€å¹¶æŒ‰åŸæ ·æ‰§è¡Œå‡½æ•°çš„å…¶ä½™éƒ¨åˆ†ã€‚é¦–å…ˆï¼Œå¿…é¡»ä» DLL æ–‡ä»¶ä¸­æ¢å¤è¢«ç›‘æ§å‡½æ•°çš„åŸå§‹å­—èŠ‚ï¼Œè¿™äº›å­—èŠ‚å·²ç»è¢«å®‰è£…é’©å­çš„ EDR è¦†ç›–ã€‚åœ¨æˆ‘ä»¬ä¹‹å‰çš„ä»£ç ç¤ºä¾‹ä¸­ï¼Œè¿™å°†æ˜¯å¯¹åº”äºä»¥ä¸‹æŒ‡ä»¤çš„å­—èŠ‚:

**mov r10ã€rcx
mov eaxã€50h**

è¯†åˆ«è¿™äº›å­—èŠ‚æ˜¯ä¸€é¡¹ç®€å•çš„ä»»åŠ¡ï¼Œå› ä¸ºæˆ‘ä»¬èƒ½å¤Ÿå¯¹åº“çš„å†…å­˜å’Œç£ç›˜ç‰ˆæœ¬æ‰§è¡Œå¹²å‡€çš„ *diff* ï¼Œå¦‚å‰æ‰€è¿°ã€‚ç„¶åï¼Œæˆ‘ä»¬æ±‡ç¼–ä¸€ä¸ªè·³è½¬æŒ‡ä»¤ï¼Œè¯¥æŒ‡ä»¤è¢«æ„å»ºæ¥å°†æ§åˆ¶æµé‡å®šå‘åˆ°åœ°å€`**NtProtectVirtualMemory + sizeof(overwritten_instructions)**`å¤„ç´§éšé’©å­ä¹‹åçš„ä»£ç 

**jmp NtProtectVirtualMemory+8**

æœ€åï¼Œæˆ‘ä»¬è¿æ¥è¿™äº›æ“ä½œç ï¼Œå°†å®ƒä»¬å­˜å‚¨åœ¨(æ–°çš„)å¯æ‰§è¡Œå†…å­˜ä¸­ï¼Œå¹¶ä¿ç•™ä¸€ä¸ªæŒ‡å‘å®ƒä»¬çš„æŒ‡é’ˆã€‚è¿™ä¸ªå¯¹è±¡è¢«ç§°ä¸ºä¸€ä¸ªâ€œ*è¹¦åºŠ*ï¼Œç„¶åå¯ä»¥è¢«ç”¨ä½œä¸€ä¸ªå‡½æ•°æŒ‡é’ˆï¼Œä¸¥æ ¼æ¥è¯´ç›¸å½“äºåŸæ¥çš„`**NtProtectVirtualMemory**`å‡½æ•°ã€‚

è¿™ç§æŠ€æœ¯çš„ä¸»è¦å¥½å¤„æ˜¯æŒ‚é’©æ°¸è¿œä¸ä¼šè¢«åˆ é™¤ï¼Œå› æ­¤ EDR å¯¹æŒ‚é’©æ‰§è¡Œçš„ä»»ä½•å®Œæ•´æ€§æ£€æŸ¥éƒ½åº”è¯¥é€šè¿‡ã€‚ç„¶è€Œï¼Œå®ƒéœ€è¦åˆ†é…å¯å†™ç„¶åå¯æ‰§è¡Œçš„å†…å­˜ï¼Œè¿™æ˜¯ä¸€ä¸ªå…¸å‹çš„å¤–å£³ä»£ç åˆ†é…ï¼Œå› æ­¤å¸å¼•äº† EDR çš„å®¡æŸ¥ã€‚

å®ç°ç»†èŠ‚ï¼ŒæŸ¥çœ‹`**unhook_method**`ä¸º`**UNHOOK_WITH_INHOUSE_NTPROTECTVIRTUALMEMORY_TRAMPOLINE**`æ—¶`**unhook()**`å‡½æ•°çš„ä»£ç è·¯å¾„ã€‚è¯·è®°ä½ï¼Œè¯¥æŠ€æœ¯ä»…åœ¨æˆ‘ä»¬çš„å®ç°ä¸­å±•ç¤ºï¼Œå¹¶ä¸”æœ€ç»ˆç”¨äº**ä»å†…å­˜ä¸­ç§»é™¤**é’©å­ï¼Œæ¯ç§æŠ€æœ¯å¦‚ä¸‹ã€‚

#### åˆ©ç”¨è‡ªå¸¦çš„ EDR è¹¦åºŠç»•è¿‡é’©å­

EDR äº§å“ï¼Œä¸ºäº†è®©å®ƒçš„é’©å­å·¥ä½œï¼Œå¿…é¡»åœ¨å†…å­˜çš„æŸä¸ªåœ°æ–¹ä¿å­˜å®ƒå·²ç»åˆ é™¤çš„æ“ä½œç ã€‚æœ€å·®(*æˆ–â€œæ›´å¥½â€ï¼Œä»æ”»å‡»è€…çš„è§’åº¦æ¥çœ‹*)ï¼Œä¸ºäº†æœ‰æ•ˆåœ°ä½¿ç”¨åŸå§‹æŒ‡ä»¤ï¼ŒEDR å¯èƒ½å·²ç»åœ¨æŸä¸ªåœ°æ–¹ä¸ºè‡ªå·±åˆ†é…äº†ä¸€ä¸ª*è¹¦åºŠ*æ¥åœ¨æ‹¦æˆªè°ƒç”¨åæ‰§è¡ŒåŸå§‹å‡½æ•°ã€‚

è¿™ä¸ª trampoline å¯ä»¥è¢«æœç´¢å¹¶ä½œä¸ºæŒ‚é’©å‡½æ•°çš„æ›¿ä»£ï¼Œè€Œä¸éœ€è¦åˆ†é…å¯æ‰§è¡Œå†…å­˜ï¼Œä¹Ÿä¸éœ€è¦è°ƒç”¨é™¤äº†`**VirtualQuery**`ä¹‹å¤–çš„ä»»ä½• APIï¼Œå®ƒå¾ˆå¯èƒ½æ˜¯ä¸€ä¸ªæ— å®³çš„å‡½æ•°è€Œæ²¡æœ‰è¢«ç›‘æ§åˆ°ã€‚

ä¸ºäº†æ‰¾åˆ°å†…å­˜ä¸­çš„è¹¦åºŠï¼Œæˆ‘ä»¬ä½¿ç”¨`**VirtualQuery**`æ¥æµè§ˆæ•´ä¸ªåœ°å€ç©ºé—´ï¼Œå¯»æ‰¾æäº¤çš„å’Œå¯æ‰§è¡Œçš„å†…å­˜ã€‚å¯¹äºæ¯ä¸€ä¸ªè¿™æ ·çš„å†…å­˜åŒºåŸŸï¼Œæˆ‘ä»¬æ‰«æå®ƒæ¥å¯»æ‰¾ä¸€ä¸ªè·³è½¬æŒ‡ä»¤ï¼Œè¿™ä¸ªè·³è½¬æŒ‡ä»¤çš„ç›®æ ‡åœ°å€åœ¨è¢«è¦†ç›–çš„æŒ‡ä»¤ä¹‹å(åœ¨æˆ‘ä»¬å‰é¢çš„ä¾‹å­ä¸­æ˜¯`**NtProtectVirtualMemory+8**`)ã€‚ç„¶åï¼Œè¹¦åºŠå¯ä»¥ç”¨æ¥è°ƒç”¨è¢«æŒ‚é’©çš„å‡½æ•°ï¼Œè€Œä¸ä¼šè§¦å‘æŒ‚é’©ã€‚

è¿™ç§æŠ€æœ¯æƒŠäººåœ°æœ‰æ•ˆï¼Œå› ä¸ºå®ƒåœ¨æµ‹è¯•è¿‡çš„ EDR ä¸Šå‡ ä¹æ¢å¤äº†æ‰€æœ‰çš„è¹¦åºŠã€‚å®ç°ç»†èŠ‚ï¼ŒæŸ¥çœ‹`**unhook_method**`ä¸º`**UNHOOK_WITH_EDR_NTPROTECTVIRTUALMEMORY_TRAMPOLINE**`æ—¶`**unhook()**`å‡½æ•°çš„ä»£ç è·¯å¾„ã€‚

#### ä½¿ç”¨é‡å¤çš„ DLL æŒ‚æ¥æ—è·¯

å¦ä¸€ä¸ªè®¿é—®ä¸å—ç›‘æ§ç‰ˆæœ¬çš„`**NtProtectVirtualMemory**`å‡½æ•°çš„ç®€å•æ–¹æ³•æ˜¯å°†å¤åˆ¶ç‰ˆæœ¬çš„`**ntdll.dll**`åº“åŠ è½½åˆ°è¿›ç¨‹åœ°å€ç©ºé—´ä¸­ã€‚ç”±äºä¸¤ä¸ªç›¸åŒçš„ dll å¯ä»¥åœ¨åŒä¸€ä¸ªè¿›ç¨‹ä¸­åŠ è½½ï¼Œå‡è®¾å®ƒä»¬æœ‰ä¸åŒçš„åå­—ï¼Œæˆ‘ä»¬å¯ä»¥ç®€å•åœ°å°†åˆæ³•çš„`**ntdll.dll**`æ–‡ä»¶å¤åˆ¶åˆ°å¦ä¸€ä¸ªä½ç½®ï¼Œä½¿ç”¨ **`LoadLibrary`** åŠ è½½å®ƒ(æˆ–é‡æ–°å®ç°åŠ è½½è¿›ç¨‹)ï¼Œå¹¶ä½¿ç”¨ä¾‹å¦‚`**GetProcAddress**`æ¥è®¿é—®å‡½æ•°ã€‚

è¿™ç§æŠ€æœ¯å¾ˆå®¹æ˜“ç†è§£å’Œå®ç°ï¼Œå¹¶ä¸”æœ‰ç›¸å½“å¤§çš„æˆåŠŸæœºä¼šï¼Œå› ä¸ºä¸€æ—¦è¿›ç¨‹è¿è¡Œï¼Œå¤§å¤šæ•° EDR äº§å“ä¸ä¼šåœ¨æ–°åŠ è½½çš„ dll ä¸Šé‡æ–°å®‰è£…é’©å­ã€‚ç„¶è€Œï¼Œä¸»è¦çš„ç¼ºç‚¹æ˜¯ä»¥ä¸åŒçš„åå­—å¤åˆ¶å¾®è½¯ç­¾åçš„äºŒè¿›åˆ¶æ–‡ä»¶ç»å¸¸è¢« EDR äº§å“è®¤ä¸ºæ˜¯å¯ç–‘çš„ã€‚

è¿™ç§æŠ€æœ¯ä»ç„¶åœ¨`**EDRSandblast**`ä¸­å®ç°ã€‚å…·ä½“å®ç°è¯·æŸ¥çœ‹`**unhook_method**`ä¸º**T3 æ—¶`**unhook()**`å‡½æ•°çš„ä»£ç è·¯å¾„ã€‚**

#### ä½¿ç”¨ç›´æ¥ç³»ç»Ÿè°ƒç”¨æŒ‚æ¥æ—è·¯

ä¸ºäº†ä½¿ç”¨ä¸ç³»ç»Ÿè°ƒç”¨ç›¸å…³çš„åŠŸèƒ½ï¼Œä¸€ä¸ªç¨‹åºå¯ä»¥é‡æ–°æ‰§è¡Œ syscalls(åœ¨æ±‡ç¼–ä¸­),ä»¥ä¾¿è°ƒç”¨ç›¸åº”çš„æ“ä½œç³»ç»Ÿç‰¹æ€§ï¼Œè€Œæ— éœ€å®é™…æ¥è§¦`**ntdll.dll**`ä¸­çš„ä»£ç ï¼Œè¿™å¯èƒ½ä¼šè¢« EDR ç›‘æ§ã€‚è¿™å®Œå…¨ç»•è¿‡äº†åœ¨`**ntdll.dll**`ä¸­å¯¹ syscall å‡½æ•°è¿›è¡Œçš„ä»»ä½•ç”¨æˆ·åŸŸæŒ‚é’©ã€‚

ç„¶è€Œï¼Œè¿™ä¹Ÿæœ‰ä¸€äº›ç¼ºç‚¹ã€‚é¦–å…ˆï¼Œè¿™æ„å‘³ç€èƒ½å¤ŸçŸ¥é“ç¨‹åºéœ€è¦çš„å‡½æ•°çš„ç³»ç»Ÿè°ƒç”¨å·åˆ—è¡¨ï¼Œè¯¥åˆ—è¡¨å›  Windows çš„æ¯ä¸ªç‰ˆæœ¬è€Œå¼‚ã€‚æ­¤å¤–ï¼ŒæŠ€æœ¯ä¸Šä¸æ˜¯ç³»ç»Ÿè°ƒç”¨çš„å‡½æ•°(ä¾‹å¦‚ **`LoadLibraryX` / `LdrLoadDLL`** )ä¹Ÿå¯ä»¥è¢«ç›‘æ§ï¼Œå¹¶ä¸”ä¸èƒ½ç®€å•åœ°ä½¿ç”¨ç³»ç»Ÿè°ƒç”¨æ¥é‡æ–°å®ç°ã€‚

è¿™ç§æŠ€æœ¯æ˜¯åœ¨ edr blaster ä¸­å®ç°çš„ã€‚å¦‚å‰æ‰€è¿°ï¼Œå®ƒä»…ç”¨äºå®‰å…¨æ‰§è¡Œ`**NtProtectVirtualMemory**`ï¼Œå¹¶ç§»é™¤æ‰€æœ‰æ£€æµ‹åˆ°çš„é’©å­ã€‚ç„¶è€Œï¼Œä¸ºäº†ä¸ä¾èµ–äºç¡¬ç¼–ç çš„åç§»é‡ï¼Œå®ç°äº†ä¸€ä¸ªå°çš„å¯å‘å¼ç®—æ³•ï¼Œåœ¨`**NtProtectVirtualMemory**`å‡½æ•°çš„å¼€å§‹å¤„æœç´¢`**mov eax, imm32**`æŒ‡ä»¤ï¼Œå¦‚æœæ‰¾åˆ°ï¼Œå°±ä»ä¸­æ¢å¤ç³»ç»Ÿè°ƒç”¨å·(å¦åˆ™ä¾èµ–äºå·²çŸ¥ Windows ç‰ˆæœ¬çš„ç¡¬ç¼–ç åç§»é‡)ã€‚

å®ç°ç»†èŠ‚ï¼ŒæŸ¥çœ‹`**unhook_method**`ä¸º`**UNHOOK_WITH_DIRECT_SYSCALL**`æ—¶`**unhook(**)`å‡½æ•°çš„ä»£ç è·¯å¾„ã€‚

### RunAsPPL æ—è·¯

åœ¨ Windows 8.1 å’Œ Windows Server 2012 R2 ä¸­é¦–æ¬¡å¼•å…¥çš„`**Local Security Authority (LSA) Protection**`æœºåˆ¶åˆ©ç”¨`**Protected Process Light (PPL)**`æŠ€æœ¯æ¥é™åˆ¶å¯¹ **`LSASS`** è¿›ç¨‹çš„è®¿é—®ã€‚`**PPL**`ä¿æŠ¤è§„èŒƒå’Œé™åˆ¶æ“ä½œï¼Œä¾‹å¦‚å—ä¿æŠ¤è¿›ç¨‹çš„å†…å­˜æ³¨å…¥æˆ–å†…å­˜è½¬å‚¨ï¼Œç”šè‡³æ¥è‡ªæŒæœ‰`**SeDebugPrivilege**`ç‰¹æƒçš„è¿›ç¨‹ã€‚åœ¨è¿›ç¨‹ä¿æŠ¤æ¨¡å¼ä¸‹ï¼Œåªæœ‰ä»¥è¾ƒé«˜ä¿æŠ¤çº§åˆ«è¿è¡Œçš„è¿›ç¨‹æ‰èƒ½å¯¹å—ä¿æŠ¤çš„è¿›ç¨‹æ‰§è¡Œæ“ä½œã€‚

Windows å†…æ ¸ç”¨æ¥è¡¨ç¤ºå†…æ ¸å†…å­˜ä¸­è¿›ç¨‹çš„`**_EPROCESS**`ç»“æ„åŒ…æ‹¬ä¸€ä¸ª`**_PS_PROTECTION**`å­—æ®µï¼Œé€šè¿‡å…¶ **`Type` ( `_PS_PROTECTED_TYPE` )** å’Œ **`Signer` ( `_PS_PROTECTED_SIGNER`** )å±æ€§å®šä¹‰è¿›ç¨‹çš„ä¿æŠ¤çº§åˆ«ã€‚

é€šè¿‡åœ¨å†…æ ¸å†…å­˜ä¸­å†™å…¥ï¼Œedr blaster è¿›ç¨‹èƒ½å¤Ÿå°†å…¶è‡ªèº«çš„ä¿æŠ¤çº§åˆ«å‡çº§åˆ°`**PsProtectedSignerWinTcb-Light**`ã€‚è¿™ä¸ªçº§åˆ«è¶³ä»¥è½¬å‚¨`**LSASS**`è¿›ç¨‹å†…å­˜ï¼Œå› ä¸ºå®ƒâ€œæ”¯é…â€äº`**PsProtectedSignerLsa-Light**`ï¼Œå³è¿è¡Œ`**RunAsPPL**`æœºåˆ¶çš„`**LSASS**`è¿›ç¨‹çš„ä¿æŠ¤çº§åˆ«ã€‚

`**EDRSandBlast**`å®ç°å¦‚ä¸‹è‡ªæˆ‘ä¿æŠ¤:

*   æ‰“å¼€å½“å‰è¿›ç¨‹çš„å¥æŸ„
*   æ³„æ¼æ‰€æœ‰ç³»ç»Ÿå¥æŸ„ä½¿ç”¨`**NtQuerySystemInformatio**n`æŸ¥æ‰¾å½“å‰è¿›ç¨‹ä¸Šæ‰“å¼€çš„å¥æŸ„ï¼Œä»¥åŠå½“å‰è¿›ç¨‹çš„åœ°å€' **`EPROCESS`** ç»“æ„åœ¨å†…æ ¸å†…å­˜ä¸­ã€‚
*   åˆ©ç”¨`**Micro-Star MSI Afterburner**`é©±åŠ¨ç¨‹åºçš„ä»»æ„è¯»/å†™æ¼æ´ï¼Œè¦†ç›–å†…æ ¸å†…å­˜ä¸­å½“å‰è¿›ç¨‹çš„`**_PS_PROTECTION**`å­—æ®µã€‚ç›¸å¯¹äº`**EPROCESS**`ç»“æ„çš„`**_PS_PROTECTION**`å­—æ®µçš„åç§»é‡(ç”±æ­£åœ¨ä½¿ç”¨çš„`**ntoskrnl**`ç‰ˆæœ¬å®šä¹‰)è¢«ç¡¬ç¼–ç åœ¨`**NtoskrnlOffsets.csv**`æ–‡ä»¶ä¸­ã€‚

### å‡­è¯ä¿æŠ¤æ—è·¯

å¾®è½¯çš„`**Credential Guard**`æ˜¯ä¸€ç§åŸºäºè™šæ‹ŸåŒ–çš„éš”ç¦»æŠ€æœ¯ï¼Œåœ¨å¾®è½¯çš„`**Windows 10 (Enterprise edition)**`ä¸­å¼•å…¥ï¼Œé˜²æ­¢ç›´æ¥è®¿é—®å­˜å‚¨åœ¨`**LSASS**`è¿›ç¨‹ä¸­çš„å‡­è¯ã€‚

å½“`**Credentials Guard**`è¢«æ¿€æ´»æ—¶ï¼Œåœ¨`**Virtual Secure Mode**`ä¸­ä¼šåˆ›å»ºä¸€ä¸ª`**LSAIso**` ( *LSA éš”ç¦»*)è¿›ç¨‹ï¼Œè¯¥ç‰¹æ€§åˆ©ç”¨ CPU çš„è™šæ‹ŸåŒ–æ‰©å±•æ¥ä¸ºå†…å­˜ä¸­çš„æ•°æ®æä¾›é¢å¤–çš„å®‰å…¨æ€§ã€‚å¯¹`**LSAIso**`è¿›ç¨‹çš„è®¿é—®å—åˆ°é™åˆ¶ï¼Œå³ä½¿æ˜¯å¯¹å…·æœ‰`**NT AUTHORITY\SYSTEM**`å®‰å…¨ä¸Šä¸‹æ–‡çš„è®¿é—®ã€‚å½“å¤„ç†æ•£åˆ—æ—¶ï¼Œ`**LSA**`è¿›ç¨‹æ‰§è¡Œå¯¹`**LSAIso**`è¿›ç¨‹çš„`**RPC**`è°ƒç”¨ï¼Œå¹¶ç­‰å¾…`**LSAIso**`ç»“æœç»§ç»­ã€‚å› æ­¤ï¼Œ`**LSASS**`è¿›ç¨‹å°†ä¸ä¼šåŒ…å«ä»»ä½•ç§˜å¯†ï¼Œå¹¶å°†å°±åœ°å­˜å‚¨`**LSA Isolated Data**`ã€‚

å¦‚ **`N4kedTurtle`çš„åŸå§‹ç ”ç©¶æ‰€è¿°:é€šè¿‡ä¿®è¡¥å†…å­˜ä¸­`**g_fParameter_useLogonCredential**`å’Œ`**g_IsCredGuardEnabled**`çš„å€¼ï¼Œå¯ä»¥åœ¨å…·æœ‰å‡­è¯ä¿æŠ¤çš„ç³»ç»Ÿä¸Šå¯ç”¨`Wdigest`** ã€‚æ¿€æ´»`**Wdigest**`å°†å¯¼è‡´æ˜æ–‡å‡­è¯å­˜å‚¨åœ¨`**LSASS**`å†…å­˜ä¸­ï¼Œç”¨äºä»»ä½•æ–°çš„äº¤äº’å¼ç™»å½•(æ— éœ€é‡å¯ç³»ç»Ÿ)ã€‚å…³äºè¿™é¡¹æŠ€æœ¯çš„æ›´å¤šç»†èŠ‚ï¼Œè¯·å‚è€ƒåŸå§‹çš„ç ”ç©¶åšå®¢ã€‚

`**EDRSandBlast**`ç®€å•åœ°ä½¿æœ€åˆçš„ PoC å¯¹ opsec æ›´åŠ å‹å¥½ï¼Œå¹¶æä¾›å¯¹è®¸å¤š`**wdigest.dll**`ç‰ˆæœ¬çš„æ”¯æŒ(é€šè¿‡å¯¹`**g_fParameter_useLogonCredential**`å’Œ**)**çš„ç¡¬ç¼–ç è¡¥å¿)ã€‚

### ntoskrnl å’Œ wdigest åç§»é‡

ä½¿ç”¨`**r2pipe**`æå–æ‰€éœ€çš„`**ntoskrnl.exe**`å’Œ`**wdigest.dll**`åç§»é‡(å¦‚ä¸Šæ‰€è¿°)ï¼Œå¦‚ **`ExtractOffsets.py` `Python`** è„šæœ¬ä¸­æ‰€å®ç°çš„ã€‚ä¸ºäº†æ”¯æŒæ›´å¤šçš„ Windows ç‰ˆæœ¬ï¼Œå¯ä»¥è‡ªåŠ¨ä¸‹è½½ Winbindex å¼•ç”¨çš„`**ntoskrnl.exe**`å’Œ`**wdigest.dll**`(å¹¶æå–å®ƒä»¬çš„åç§»é‡)ã€‚è¿™å…è®¸ä»å‡ ä¹æ‰€æœ‰åœ¨ Windows update åŒ…ä¸­å‘å¸ƒçš„æ–‡ä»¶ä¸­æå–åç§»é‡(åˆ°ç›®å‰ä¸ºæ­¢æ˜¯ 350+ `**ntoskrnl.exe**`å’Œ 30+ `**wdigest.dll**`ç‰ˆæœ¬)ã€‚

## ç”¨æ³•

æ˜“å—æ”»å‡»çš„ **`RTCore64.sys`** é©±åŠ¨ç¨‹åºå¯åœ¨ä»¥ä¸‹ç½‘å€æ£€ç´¢:

**http://download-Eu2 . guru 3d . com/afterburner/% 5b guru 3d . com % 5D-msiafterburnersetup 462 beta 2 . zip**

## å¿«é€Ÿä½¿ç”¨

**ç”¨æ³•:EDRSandblast.exe[-h |â€“help][-v |â€“verbose][â€“user mode[â€“unhook-method]][â€“kernel mode][â€“dont-unload-driver][â€“dont-restore-callbacks][â€“driver][â€“service][â€“nt-offsets][â€“wdigest-offsets][â€“add-dll]*[-o |â€“dump-output]**

## é€‰æ‹©

**-h |â€“å¸®åŠ©æ˜¾ç¤ºæ­¤å¸®åŠ©æ¶ˆæ¯å¹¶é€€å‡ºã€‚
-v |â€“verbose å¯ç”¨æ›´è¯¦ç»†çš„è¾“å‡ºã€‚
åŠ¨ä½œæ¨¡å¼:
å®¡è®¡æ˜¾ç¤ºç”¨æˆ·ç™»é™†é’©å­å’Œ/æˆ–å†…æ ¸å›è°ƒè€Œä¸é‡‡å–åŠ¨ä½œã€‚
è½¬å‚¨è½¬å‚¨ lsass è¿›ç¨‹ï¼Œé»˜è®¤ä¸º' LSASS 'åœ¨å½“å‰ç›®å½•ä¸‹æˆ–è€…åœ¨
ä½¿ç”¨-o |â€“output æŒ‡å®šçš„æ–‡ä»¶ä¸‹ã€‚
cmd æ‰“å¼€ cmd.exe æç¤ºç¬¦ã€‚
credguard ä¿®è¡¥ LSASS è¿›ç¨‹çš„å†…å­˜ï¼Œä»¥å¯ç”¨ Wdigest æ˜æ–‡å¯†ç ç¼“å­˜ï¼Œå³ä½¿åœ¨ä¸»æœºä¸Šå¯ç”¨äº†
å‡­æ®ä¿æŠ¤ã€‚ä¸éœ€è¦å†…æ ¸æ“ä½œã€‚
â€“ç”¨æˆ·æ¨¡å¼æ‰§è¡Œç”¨æˆ·ç™»é™†æ“ä½œ(DLL è„±é’©)ã€‚
â€“Kernel mode æ‰§è¡Œå†…æ ¸ç€é™†æ“ä½œ(å†…æ ¸å›è°ƒç§»é™¤å’Œ ETW TI ç¦ç”¨)ã€‚
â€“unhook-method
ä»ä»¥ä¸‹é€‰é¡¹ä¸­é€‰æ‹©ç”¨æˆ·åŒºåŸŸå–æ¶ˆæŒ‚é’©æŠ€æœ¯:
1(é»˜è®¤)ä½¿ç”¨ ntdll ä¸­çš„(å¯èƒ½è¢«ç›‘æ§çš„)NtProtectVirtualMemory å‡½æ•°æ¥åˆ é™¤æ‰€æœ‰
å­˜åœ¨çš„ç”¨æˆ·åŒºåŸŸæŒ‚é’©ã€‚
2 é€šè¿‡
åˆ†é…ä¸€ä¸ªè·³è¿‡é’©å­çš„å¯æ‰§è¡Œè¹¦åºŠï¼Œå¹¶ç§»é™¤æ‰€æœ‰å½“å‰çš„
ç”¨æˆ·åŒºé’©å­ï¼Œæ„å»ºäº†ä¸€ä¸ªâ€œè„±é’©â€(å³ä¸å—ç›‘æ§)ç‰ˆæœ¬çš„ NtProtectVirtualMemoryã€‚
3 æœç´¢ç”± EDR è‡ªå·±åˆ†é…çš„ç°æœ‰è¹¦åºŠï¼Œä»¥è·å¾— NtProtectVirtualMemory çš„â€œè„±é’©çš„â€
(å³ä¸å—ç›‘æ§çš„)ç‰ˆæœ¬ï¼Œå¹¶ç§»é™¤æ‰€æœ‰å½“å‰ç”¨æˆ·åŒºåŸŸçš„
æŒ‚é’©ã€‚
4 å°†ä¸€ä¸ªé™„åŠ ç‰ˆæœ¬çš„ ntdll åº“åŠ è½½åˆ°å†…å­˜ä¸­ï¼Œå¹¶ä½¿ç”¨è¿™ä¸ªåº“ä¸­çš„ NtProtectVirtualMemory(å¸Œæœ›æ˜¯
æœªè¢«ç›‘æ§çš„)ç‰ˆæœ¬æ¥ç§»é™¤æ‰€æœ‰
å½“å‰çš„ç”¨æˆ·åŸŸé’©å­ã€‚
5 åˆ†é…ä¸€ä¸ª shellcode ä½¿ç”¨ç›´æ¥ syscall è°ƒç”¨ NtProtectVirtualMemoryï¼Œ
å¹¶ä½¿ç”¨å®ƒç§»é™¤æ‰€æœ‰æ£€æµ‹åˆ°çš„é’©å­
å…¶ä»–é€‰é¡¹:
â€“don-unload-driver ä¿ç•™ä¸»æœºä¸Šå®‰è£…çš„å¾®æ˜Ÿ MSI åŠ åŠ›æ¼æ´é©±åŠ¨
é»˜è®¤è‡ªåŠ¨å¸è½½é©±åŠ¨ã€‚
â€“dont-restore-Callbacks ä¸æ¢å¤å·²åˆ é™¤çš„ EDR é©±åŠ¨ç¨‹åºå†…æ ¸å›è°ƒã€‚
é»˜è®¤æ¢å¤å›è°ƒã€‚
â€“å¾®æ˜Ÿ MSI åŠ åŠ›ç‡ƒçƒ§å®¤æ˜“å—æ”»å‡»é©±åŠ¨ç¨‹åºæ–‡ä»¶çš„é©±åŠ¨ç¨‹åºè·¯å¾„ã€‚
é»˜è®¤ä¸ºå½“å‰ç›®å½•ä¸‹çš„â€˜rtcore 64 . sysâ€™ã€‚
â€“è¦å®‰è£…/å¯åŠ¨çš„æ˜“å—æ”»å‡»æœåŠ¡çš„æœåŠ¡åã€‚
â€“åŒ…å«æ‰€éœ€ ntoskrnl.exe åç§»é‡çš„ CSV æ–‡ä»¶çš„ nt-offsets è·¯å¾„ã€‚
é»˜è®¤ä¸ºå½“å‰ç›®å½•ä¸‹çš„â€˜ntoskrnloffsets . CSVâ€™ã€‚
â€“wdigest-offsets åŒ…å«æ‰€éœ€ wdigest.dll åç§»é‡çš„ CSV æ–‡ä»¶è·¯å¾„
(ä»…é€‚ç”¨äºâ€œcredguardâ€æ¨¡å¼)ã€‚
é»˜è®¤ä¸ºå½“å‰ç›®å½•ä¸­çš„â€˜wdigestoffsets . CSVâ€™ã€‚
â€“åœ¨å¼€å§‹
ä»»ä½•æ“ä½œä¹‹å‰ï¼Œadd-dll å°†ä»»æ„åº“åŠ è½½åˆ°è¿›ç¨‹çš„åœ°å€ç©ºé—´ä¸­ã€‚è¿™æœ‰åŠ©äºå®¡è®¡ DLL çš„ç”¨æˆ·ç•Œé¢æŒ‚é’©ï¼Œè¿™äº› DLL ä¸æ˜¯ç”±è¿™ä¸ªç¨‹åºé»˜è®¤åŠ è½½çš„
ã€‚å¤šæ¬¡ä½¿ç”¨è¿™ä¸ªé€‰é¡¹æ¥ä¸€æ¬¡åŠ è½½å¤šä¸ª
dllã€‚
æœ‰è¶£çš„ dll ç¤ºä¾‹:shell32.dllã€shell32.dllã€shell32.dllã€
samcli.dllã€winhttp.dllã€urlmon.dllã€shell32.dllã€shell32 . dllâ€¦
-o |â€“å°†ç”±â€œè½¬å‚¨â€æ¨¡å¼ç”Ÿæˆçš„è½¬å‚¨æ–‡ä»¶çš„è¾“å‡ºè·¯å¾„ã€‚
å½“å‰ç›®å½•ä¸­é»˜è®¤ä¸ºâ€˜lsassâ€™**toryã€‚

### å»ºè®¾

`**EDRSandBlast**`(ä»…é™ x64)åŸºäº Visual Studio 2019 (Windows SDK ç‰ˆæœ¬: **`10.0.19041.0` a** nd å¹³å°å·¥å…·é›†:`**Visual Studio 2019 (v142)**`)æ„å»ºã€‚

### ExtractOffsets.py ç”¨æ³•

æ³¨æ„`**ExtractOffsets.py**`åªåœ¨ Windows ä¸Šæµ‹è¯•è¿‡ã€‚

# Python ä¾èµ–é¡¹çš„å®‰è£…

pip.exe å®‰è£…-m .\requirements.txt

# è„šæœ¬ç”¨æ³•

**extract offsets . py[-h]-I INPUT[-o OUTPUT][-d]mode
ä½ç½®å‚æ•°:
mode ntoskrnl æˆ– wdigestã€‚ä¸‹è½½å¹¶æå– ntoskrnl æˆ– wdigest
çš„åç§»é‡çš„æ¨¡å¼å¯é€‰å‚æ•°:
-hï¼Œâ€“å¸®åŠ©æ˜¾ç¤ºæ­¤å¸®åŠ©æ¶ˆæ¯å¹¶é€€å‡º
-i è¾“å…¥ï¼Œâ€“è¾“å…¥è¾“å…¥
åŒ…å«è¦ä»ä¸­æå–åç§»é‡çš„ ntoskrnl.exe/wdigest.dll çš„å•ä¸ªæ–‡ä»¶æˆ–ç›®å½•ã€‚
å¦‚æœåœ¨ä¸‹è½½æ¨¡å¼ä¸‹ï¼Œä» MS symbols æœåŠ¡å™¨ä¸‹è½½çš„ PE å°†æ”¾åœ¨è¯¥æ–‡ä»¶å¤¹ä¸­ã€‚
-o OUTPUTï¼Œâ€“OUTPUT è¾“å‡º
è¦å†™å…¥åç§»é‡çš„ CSV æ–‡ä»¶ã€‚å¦‚æœæŒ‡å®šçš„æ–‡ä»¶å·²ç»å­˜åœ¨ï¼Œå°†åªä¸‹è½½/åˆ†ææ–°çš„ ntoskrnl ç‰ˆæœ¬
ã€‚
é»˜è®¤ä¸ºå½“å‰æ–‡ä»¶å¤¹ä¸­çš„ ntoskrnloffsets . CSV/wdigestoffsets . CSVã€‚
-dï¼Œâ€“ä½¿ç”¨æ¥è‡ª winbindex.m417z.com çš„ç‰ˆæœ¬åˆ—è¡¨ä» Microsoft æœåŠ¡å™¨ä¸‹è½½ PE çš„ download æ ‡å¿—ã€‚**

## ä¾¦æŸ¥

ä»é˜²å¾¡è€…(EDR å‚å•†ã€å¾®è½¯ã€å…³æ³¨ EDR é¥æµ‹æŠ€æœ¯çš„ SOC åˆ†æå¸ˆâ€¦â€¦)çš„è§’åº¦æ¥çœ‹ï¼Œå¯ä»¥ä½¿ç”¨å¤šç§æŒ‡æ ‡æ¥æ£€æµ‹æˆ–é˜»æ­¢è¿™ç§æŠ€æœ¯ã€‚

### é©±åŠ¨ç¨‹åºç™½åå•

ç”±äºè¯¥å·¥å…·åœ¨å†…æ ¸æ¨¡å¼å†…å­˜ä¸­æ‰§è¡Œçš„æ¯ä¸ªæ“ä½œéƒ½ä¾èµ–äºæ˜“å—æ”»å‡»çš„é©±åŠ¨ç¨‹åºæ¥è¯»å–/å†™å…¥ä»»æ„å†…å®¹ï¼Œå› æ­¤ EDR äº§å“(æˆ– SOC åˆ†æå¸ˆ)åº”è¯¥ä¸¥æ ¼å®¡æŸ¥é©±åŠ¨ç¨‹åºåŠ è½½äº‹ä»¶ï¼Œå¹¶åœ¨ä»»ä½•ä¸å¯»å¸¸çš„é©±åŠ¨ç¨‹åºåŠ è½½æ—¶å‘å‡ºè­¦æŠ¥ï¼Œç”šè‡³é˜»æ­¢å·²çŸ¥çš„æ˜“å—æ”»å‡»çš„é©±åŠ¨ç¨‹åºã€‚åä¸€ç§æ–¹æ³•ç”šè‡³æ˜¯å¾®è½¯è‡ªå·±æ¨èçš„:ä»»ä½•æ”¯æŒ HVCI ( *Hypervisor ä¿æŠ¤çš„ä»£ç å®Œæ•´æ€§*)çš„ Windows è®¾å¤‡éƒ½åµŒå…¥äº†é©±åŠ¨ç¨‹åºé˜»æ­¢åˆ—è¡¨ï¼Œè¿™å°†é€æ¸æˆä¸º Windows ä¸Šçš„é»˜è®¤è¡Œä¸º(å®ƒå·²ç»åœ¨ Windows 11 ä¸Šå®ç°äº†)ã€‚

### å†…æ ¸å†…å­˜å®Œæ•´æ€§æ£€æŸ¥

ç”±äºæ”»å‡»è€…ä»ç„¶å¯ä»¥ä½¿ç”¨æœªçŸ¥çš„æ˜“å—æ”»å‡»çš„é©±åŠ¨ç¨‹åºåœ¨å†…å­˜ä¸­æ‰§è¡Œç›¸åŒçš„æ“ä½œï¼ŒEDR é©±åŠ¨ç¨‹åºå¯ä»¥å®šæœŸæ£€æŸ¥å…¶å†…æ ¸å›è°ƒæ˜¯å¦ä»ç„¶æ³¨å†Œï¼Œç›´æ¥é€šè¿‡æ£€æŸ¥å†…æ ¸å†…å­˜(å°±åƒè¯¥å·¥å…·æ‰€åšçš„é‚£æ ·)ï¼Œæˆ–è€…ç®€å•åœ°é€šè¿‡è§¦å‘äº‹ä»¶(è¿›ç¨‹åˆ›å»ºã€çº¿ç¨‹åˆ›å»ºã€æ˜ åƒåŠ è½½ç­‰)ã€‚)å¹¶æ£€æŸ¥å›è°ƒå‡½æ•°ç¡®å®æ˜¯ç”±æ‰§è¡Œå†…æ ¸è°ƒç”¨çš„ã€‚

é¡ºä¾¿æä¸€ä¸‹ï¼Œè¿™ç§ç±»å‹çš„æ•°æ®ç»“æ„å¯ä»¥é€šè¿‡æœ€è¿‘çš„å†…æ ¸æ•°æ®ä¿æŠ¤(KDP)æœºåˆ¶æ¥ä¿æŠ¤ï¼Œè¯¥æœºåˆ¶ä¾èµ–äºåŸºäºè™šæ‹Ÿçš„å®‰å…¨æ€§ï¼Œä»¥ä¾¿åœ¨ä¸è°ƒç”¨æ­£ç¡®çš„ API çš„æƒ…å†µä¸‹ä½¿å†…æ ¸å›è°ƒæ•°ç»„ä¸å¯å†™ã€‚

åŒæ ·çš„é€»è¾‘ä¹Ÿé€‚ç”¨äºæ•æ„Ÿçš„ ETW å˜é‡ï¼Œå¦‚`**ProviderEnableInfo**`ï¼Œè¯¥å·¥å…·æ»¥ç”¨å®ƒæ¥ç¦ç”¨ ETW å¨èƒæƒ…æŠ¥äº‹ä»¶ç”Ÿæˆã€‚

### ç”¨æˆ·æ¨¡å¼æ£€æµ‹

ä¸€ä¸ªè¿›ç¨‹ä¸»åŠ¨è¯•å›¾é¿å¼€ç”¨æˆ·ç™»é™†æŒ‚é’©çš„ç¬¬ä¸€ä¸ªæ ‡å¿—æ˜¯å¯¹ä¸åŠ è½½çš„æ¨¡å—ç›¸å¯¹åº”çš„æ¯ä¸ª DLL çš„æ–‡ä»¶è®¿é—®ï¼›åœ¨æ­£å¸¸æ‰§è¡Œä¸­ï¼Œç”¨æˆ·åŸŸè¿›ç¨‹å¾ˆå°‘éœ€è¦è¯»å–`**LoadLibrary**`è°ƒç”¨ä¹‹å¤–çš„ DLL æ–‡ä»¶ï¼Œå°¤å…¶æ˜¯ **`ntdll.dll`ã€‚**

ä¸ºäº†é˜²æ­¢ API æŒ‚é’©è¢«ç»•è¿‡ï¼ŒEDR çš„äº§å“å¯ä»¥å®šæœŸæ£€æŸ¥æ¯ä¸ªè¢«ç›‘æ§çš„è¿›ç¨‹ä¸­çš„æŒ‚é’©åœ¨å†…å­˜ä¸­æ²¡æœ‰è¢«æ”¹å˜ã€‚

æœ€åï¼Œæ£€æµ‹æŒ‚é’©æ—è·¯(æ»¥ç”¨è¹¦åºŠï¼Œä½¿ç”¨ç›´æ¥ç³»ç»Ÿè°ƒç”¨ï¼Œç­‰ç­‰ã€‚)è¿™å¹¶ä¸æ„å‘³ç€é’©å­çš„ç§»é™¤ï¼ŒEDR äº§å“å¯èƒ½ä¼šä¾èµ–ä¸è¢«æ»¥ç”¨çš„ç³»ç»Ÿè°ƒç”¨(ä¾‹å¦‚`**PsCreateProcessNotifyRoutine**`ä»£è¡¨`**NtCreateProcess**`ç³»ç»Ÿè°ƒç”¨ï¼Œ`**ObRegisterCallbacks**`ä»£è¡¨`**NtOpenProcess**`ç³»ç»Ÿè°ƒç”¨ï¼Œä»¥æ­¤ç±»æ¨ã€‚)ï¼Œå¹¶æ‰§è¡Œç”¨æˆ·æ¨¡å¼è°ƒç”¨å †æ ˆåˆ†æï¼Œä»¥ç¡®å®šç³»ç»Ÿè°ƒç”¨æ˜¯ç”±æ­£å¸¸è·¯å¾„(**`kernel32.dll`->-`ntdll.dll`**->ç³»ç»Ÿè°ƒç”¨)è¿˜æ˜¯å¼‚å¸¸è·¯å¾„(ä¾‹å¦‚`**program.exe**` - >ç›´æ¥ç³»ç»Ÿè°ƒç”¨)ã€‚

[**Download**](https://github.com/wavestone-cdt/EDRSandblast)