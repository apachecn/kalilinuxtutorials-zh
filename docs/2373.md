# Elfloader:ä¸€ä¸ªä¸æ¶æ„æ— å…³çš„å¤–å£³ä»£ç  ELF æ–‡ä»¶å±•å¹³å™¨

> åŸæ–‡ï¼š<https://kalilinuxtutorials.com/elfloader/>

[![](img//7bf06bed71e63876578bcc00ce333044.png)](https://blogger.googleusercontent.com/img/a/AVvXsEhheoRB0Hk2D4FNDwv03BDB7sraq9n7516Hp06GHZj5ASW_zSBCkbMzNYOdb5vjORsNGesxTCTtD37EOwWhcREZCTrhIWSv9TAD1Sb-wcj3_oFcFxxI2qGqBDyYSdvyYIa-EHMdrNcYtZLhNLs2xbvl7kwH2-m9QMTJO8fUAOhS2FAVs6eXUp2aLDQ7=s728)

`**Elfloader**`æ˜¯ä¸€ä¸ªè¶…çº§ç®€å•çš„ ELF æ–‡ä»¶åŠ è½½å™¨ï¼Œå¯ä»¥ç”Ÿæˆ ELF çš„å¹³é¢å†…å­˜è¡¨ç¤ºã€‚

å°†å®ƒä¸ Rust ç»“åˆèµ·æ¥ï¼Œç°åœ¨ä½ å°±å¯ä»¥ç”¨ä¸€ç§åˆé€‚çš„ã€å®‰å…¨çš„é«˜çº§è¯­è¨€ç¼–å†™å¤–å£³ä»£ç äº†ã€‚LLVM å¯ä»¥ç„å‡†çš„ä»»ä½•ç›®æ ‡éƒ½å¯ä»¥ä½¿ç”¨ï¼ŒåŒ…æ‹¬ä¸ºçœŸæ­£å¥‡ç‰¹çš„å¹³å°å’Œ ABI å®šåˆ¶çš„ç›®æ ‡è§„èŒƒã€‚å–œæ¬¢åœ¨ 32 ä½ç³»ç»Ÿä¸Šä½¿ç”¨ç±»ä¼¼äº`**u64**`çš„ä¸œè¥¿ï¼Œè¾¹ç•Œæ£€æŸ¥æ•°ç»„ï¼Œåˆ†é…çš„ä¸¢å¼ƒå¤„ç†ç­‰ç­‰ğŸ™‚

å®ƒåªæ˜¯å°†æ‰€æœ‰çš„`**LOAD**`éƒ¨åˆ†è¿æ¥åœ¨ä¸€èµ·ï¼Œå¦‚æœæœ‰é—´éš™å°±ç”¨é›¶å¡«å……ï¼Œå½¢æˆä¸€ä¸ªå¤§çš„å¹³é¢æ–‡ä»¶ã€‚

è¯¥æ–‡ä»¶åŒ…æ‹¬`**.bss**`éƒ¨åˆ†çš„é›¶åˆå§‹åŒ–ï¼Œå› æ­¤å¯ä»¥ç›´æ¥ç”¨ä½œå¤–å£³ä»£ç æœ‰æ•ˆè½½è·ã€‚

å¦‚æœæ‚¨ä¸æƒ³åœ¨å¤±æ•ˆå¼€æ”¾é“¾æ¥å™¨è„šæœ¬ä¸Šæµªè´¹æ—¶é—´ï¼Œè¿™å¯èƒ½æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„æ–¹æ³•ã€‚

è¿™å¹¶ä¸å¤„ç†ä»»ä½•é‡å®šä½ï¼Œè€Œæ˜¯ç”±æ‚¨æ¥ç¡®ä¿åŸå§‹ ELF æ˜¯åŸºäºæ‚¨å¸Œæœ›å®ƒæ‰€åœ¨çš„åœ°å€ã€‚

# ç”¨æ³•

è¦ä½¿ç”¨è¯¥å·¥å…·ï¼Œåªéœ€:

**ç”¨æ³•:elf loader[â€“perms][â€“binary][â€“base =]
â€“binaryâ€“ä¸è¾“å‡º FELFï¼Œè¾“å‡ºä¸å¸¦
å…ƒæ•°æ®çš„åŸå§‹åŠ è½½å›¾åƒ
â€“permsâ€“åˆ›å»ºä¸€ä¸ªåŒ…å«æƒé™æ•°æ®çš„ FELF0002ï¼Œè¦†ç›–
â€“binary
â€“base =â€“å¼ºåˆ¶è¾“å‡ºä»`<addr>`å¼€å§‹ï¼Œå¦‚æœéœ€è¦ï¼Œä»
åŸºæ•°åˆ°ç¬¬ä¸€ä¸ªåŠ è½½æ®µçš„å¼€å§‹å¤„å¡«å……é›¶ã€‚
`<addr>`ä¸ºé»˜è®¤åå…­è¿›åˆ¶ï¼Œå¯ä»¥ç”¨`0d`ã€`0b`ã€
ã€`0o`å‰ç¼€æ›¿ä»£ã€‚
è­¦å‘Š:è¿™ä¸ä¼š*å°†*é‡æ–°å®šä½åˆ°åŸºå€ï¼Œå®ƒåªæ˜¯åœ¨`<addr>`å¼€å§‹
è¾“å‡º(æ·»åŠ é›¶å­—èŠ‚ï¼Œä»¥ä¾¿
è¾“å‡ºå›¾åƒå¯ä»¥åœ¨`<addr>`è€Œä¸æ˜¯
åŸå§‹ ELF åŸºå€åŠ è½½)
â€“è¾“å…¥ ELF çš„è·¯å¾„
â€“è¾“å‡ºæ–‡ä»¶çš„è·¯å¾„**

è¦å®‰è£…æ­¤å·¥å…·ï¼Œè¯·è¿è¡Œ:

`**cargo install --path** .`

ç°åœ¨æ‚¨å¯ä»¥åœ¨ shell çš„ä»»ä½•åœ°æ–¹ä½¿ç”¨`**elfloader**`!

# å¼€å‘

è¿™ä¸ªé¡¹ç›®æ˜¯åœ¨è¿™é‡Œå®æ—¶å¼€å‘çš„:

[https://www.youtube.com/embed/x0V-CEmXQCQ?feature=oembed](https://www.youtube.com/embed/x0V-CEmXQCQ?feature=oembed)

# ä¸¾ä¾‹

åœ¨`**example_small_program**`ä¸­æœ‰ä¸€ä¸ªä¾‹å­ï¼Œç®€å•åœ°è¿è¡Œ`**make**`æˆ–`**nmake**`ï¼Œè¿™å°†ç”Ÿæˆä¸€ä¸ª 8 å­—èŠ‚çš„`**example.bin**`ã€‚

**pleb @ gamey ~/elf loader/example _ small _ program $ make
cargo buildâ€“release
0.03s å†…å®Œæˆé‡Šæ”¾ã€ä¼˜åŒ–ã€‘ç›®æ ‡
elf loaderâ€“binary target/aarch 64-unknown-none/release/example _ small _ program example . bin
pleb @ gamey ~/elf loader/example _ small _ program $ ls-l ./example . bin
-rw-râ€“râ€“1 pleb 8 Nov 8 12:27ã€‚/example . bin
pleb @ gamey ~/elf loader/example _ small _ program $ objdump-d target/AAR ch 64-unknown-none/release/example _ small _ program
target/AAR ch 64-unknown-none/release/example _ small _ program:æ–‡ä»¶æ ¼å¼ elf64-littleaarch64
èŠ‚çš„åæ±‡ç¼–ã€‚text:
00000000133700 B0<_ start>:
133700 B0:8b 000020 add x0ï¼Œx1ï¼Œx0
133700 B4:d 65 f 03 c 0 ret**

ç°åœ¨ä½ å¯ä»¥ç”¨ Rust å†™ä½ çš„ shellcode äº†ï¼Œä¸ç”¨æ‹…å¿ƒä½ æ˜¯å¦ä¼šå‘å‡º**`.data``.rodata``.bss`**ç­‰ã€‚è¿™å°†ä¸ºä½ å¤„ç†ä¸€åˆ‡ï¼

è¿˜æœ‰ä¸€ä¸ªå…³äº`**.bss**`å’Œ`**.rodata**`çš„ä¾‹å­

**pleb @ gamey ~/elf loader/example _ program _ with _ data $ make
cargo buildâ€“release
0.04s å†…å®Œæˆå‘å¸ƒ[ä¼˜åŒ–]ç›®æ ‡
elf loaderâ€“binary target/aarch 64-unknown-none/release/example _ program _ with _ data example . bin
pleb @ gamey ~/elf loader/example _ program _ with _ data $ ls-l ./example . bin
-rw-râ€“râ€“1 pleb 29 11 æœˆ 8 æ—¥/example . bin
pleb @ gamey ~/elf loader/example _ program _ with _ data $ objdump-d target/AAR ch 64-unknown-none/release/example _ program _ with _ data
target/AAR ch 64-unknown-none/release/example _ program _ with _ data:æ–‡ä»¶æ ¼å¼ elf64-littleaarch64
èŠ‚çš„åæ±‡ç¼–ã€‚æ­£æ–‡:
0000000013370124<_ start>:
13370124:90000000 adrp x0ï¼Œ13370000<_ start-0x 124>
13370128:900000008 adrp x8ï¼Œ13370000 < _start-0x124 ã€T43 ä»åç§»é‡ 64 å¼€å§‹
ç¨‹åºå¤´:
ç±»å‹åç§»é‡ virt addr phys addr
FileSiz MemSiz æ ‡å¿—å¯¹é½
LOAD 0x 0000000000000120 0x 00000000001370120 0x 000000000001370120
0x 0000000000000004 R 0x 1
rodata
01ã€‚æ­£æ–‡
02ã€‚bss
03**

# ä¸­é—´éƒ¨åˆ†

è¿™ä¸ªå·¥å…·ä¸å…³å¿ƒé™¤äº†`**LOAD**`èŠ‚ä»¥å¤–çš„ä»»ä½•ä¸œè¥¿ã€‚å®ƒä» ELF å¤´ä¸­ç¡®å®šå­—èŠ‚åº(å°å¯¹å¤§)å’Œä½(32 å¯¹ 64)ï¼Œå¹¶ä»é‚£é‡Œæ ¹æ®ç¨‹åºå¤´è™šæ‹Ÿåœ°å€(å®ƒè¢«åŠ è½½çš„ä½ç½®)ã€æ–‡ä»¶å¤§å°(åˆå§‹åŒ–çš„å­—èŠ‚æ•°)å’Œ mem å¤§å°(å®é™…å†…å­˜åŒºåŸŸçš„å¤§å°)åˆ›å»ºä¸€ä¸ªå¹³é¢æ˜ åƒã€‚å­—èŠ‚æ ¹æ®åç§»é‡å’Œæ–‡ä»¶å¤§å°ä»æ–‡ä»¶ä¸­åˆå§‹åŒ–ï¼Œç„¶åç”¨é›¶æ‰©å±•ç›´åˆ° mem å¤§å°(å¦‚æœ mem å¤§å°å°äºæ–‡ä»¶å¤§å°ï¼Œåˆ™è¢«æˆªæ–­)ã€‚

è¿™äº›`**LOAD**`éƒ¨åˆ†ç„¶åç”¨é›¶å­—èŠ‚å¡«å……è¿æ¥åœ¨ä¸€èµ·ï¼Œä»¥å¡«è¡¥ç©ºç™½ã€‚

è¿™è¢«è®¾è®¡å¾—éå¸¸ç®€å•ï¼Œå¹¶ä¸”ä¸ ELF è¾“å…¥æ— å…³ã€‚å®ƒå¯ä»¥æ˜¯å¯æ‰§è¡Œæ–‡ä»¶ã€ç›®æ ‡æ–‡ä»¶ã€å…±äº«å¯¹è±¡ã€æ ¸å¿ƒè½¬å‚¨ç­‰ï¼Œå¹¶ä¸çœŸæ­£å…³å¿ƒã€‚å®ƒåªä¼šç»™å‡ºå†…å­˜çš„å¹³é¢è¡¨ç¤ºï¼Œä»…æ­¤è€Œå·²ã€‚

è¿™å…è®¸ä½ å°†ä»»ä½• ELF è½¬æ¢æˆå¤–å£³ä»£ç ï¼Œæˆ–è€…ä¸€ç§æ›´ç®€å•çš„æ–‡ä»¶æ ¼å¼ï¼Œæ›´å®¹æ˜“åŠ è½½åˆ°éš¾ä»¥åˆ°è¾¾çš„åŒºåŸŸï¼Œæ¯”å¦‚åµŒå…¥å¼è®¾å¤‡ã€‚å°±æˆ‘ä¸ªäººè€Œè¨€ï¼Œæˆ‘ä¸ºæˆ‘çš„ MIPS NT 4.0 åŠ è½½ç¨‹åºå¼€å‘äº†è¿™ä¸ªï¼Œå®ƒå…è®¸æˆ‘è¿è¡Œ Rust ä»£ç ã€‚

# FELF0001 æ ¼å¼

é»˜è®¤æƒ…å†µä¸‹ï¼Œæ­¤å·¥å…·ä¼šç”Ÿæˆ FELF æ–‡ä»¶æ ¼å¼ã€‚è¿™æ˜¯ä¸€ä¸ªç¦å°”å…‹ç²¾çµã€‚è¿™æ˜¯ä¸€ç§ç®€å•çš„æ–‡ä»¶æ ¼å¼:

**felf 0001â€“é­”å¤´
å…¥å£â€“å…¥å£ç‚¹åœ°å€çš„ 64 ä½å°ç«¯æ•´æ•°
åŸºå€â€“åŠ è½½å›¾åƒçš„åŸºå€çš„ 64 ä½å°ç«¯æ•´æ•°
â€“æ–‡ä»¶çš„å…¶ä½™éƒ¨åˆ†æ˜¯åŸå§‹å›¾åƒï¼Œåœ¨`base`åŠ è½½ï¼Œåœ¨`entry`** è·³è½¬

# FELF0002 æ ¼å¼(å½“ä½¿ç”¨â€“perms æ ‡å¿—æ—¶)

é»˜è®¤æƒ…å†µä¸‹ï¼Œæ­¤å·¥å…·ä¼šç”Ÿæˆ FELF æ–‡ä»¶æ ¼å¼ã€‚è¿™æ˜¯ä¸€ä¸ªç¦å°”å…‹ç²¾çµã€‚è¿™æ˜¯ä¸€ä¸ªå¸¦æœ‰æƒé™çš„ç®€å•æ–‡ä»¶æ ¼å¼:

**felf 0002â€“é­”å¤´
å…¥å£â€“å…¥å£ç‚¹åœ°å€çš„ 64 ä½å°ç«¯æ•´æ•°
åŸºå€â€“åŠ è½½å›¾åƒçš„åŸºå€çš„ 64 ä½å°ç«¯æ•´æ•°
â€“æ–‡ä»¶çš„å…¶ä½™éƒ¨åˆ†æ˜¯åŸå§‹å›¾åƒï¼Œå°†åœ¨`base`åŠ è½½å¹¶åœ¨`entry`
è·³è½¬åˆ°
â€“æƒé™ï¼ŒåŒ¹é…å…¶ä¸­å­—èŠ‚åŒ…å«
çš„å­—èŠ‚ä»¥ä¸‹æ ‡å¿—æŒ‰ä½â€œæˆ–â€è¿ç®—:
0x 01â€“å¯æ‰§è¡Œï¼Œ0x 02â€“å¯å†™ï¼Œ0x 04â€“å¯è¯»ã€T10**

[**Download**](https://github.com/gamozolabs/elfloader)