# HuskyCI:åœ¨æ‚¨çš„ CI å†…éƒ¨æ‰§è¡Œå®‰å…¨æµ‹è¯•

> åŸæ–‡ï¼š<https://kalilinuxtutorials.com/huskyci-performing-security-tests-inside-ci/>

[![HuskyCI : Performing Security Tests Inside Your CI](img//a56a5d99125ffaec057de7679b9e6a30.png "HuskyCI : Performing Security Tests Inside Your CI")](https://1.bp.blogspot.com/-vvBuKQhn96Y/XgSTxqoJAJI/AAAAAAAAEHw/NQUJVNU1--8mRnslZUmn17Ad4sp4CUXQwCLcBGAsYHQ/s1600/H.png)

HuskyCI æ˜¯ä¸€ä¸ªå¼€æºå·¥å…·ï¼Œå®ƒåè°ƒå®‰å…¨æµ‹è¯•å¹¶å°†æ‰€æœ‰ç»“æœé›†ä¸­åˆ°ä¸€ä¸ªæ•°æ®åº“ä¸­ï¼Œä»¥ä¾›è¿›ä¸€æ­¥åˆ†æå’Œè¡¡é‡ã€‚å¯ä»¥ç”¨ Python ( [Bandit](https://github.com/PyCQA/bandit) å’Œ [Safety](https://github.com/pyupio/safety) )ã€Ruby ( [Brakeman](https://github.com/presidentbeef/brakeman) )ã€JavaScript ( [Npm Audit](https://docs.npmjs.com/cli/audit) å’Œ [Yarn Audit](https://yarnpkg.com/lang/en/docs/cli/audit/) )ã€Golang ( [Gosec](https://github.com/securego/gosec) )ã€Java ( [SpotBugs](https://spotbugs.github.io) åŠ  [Find Sec Bugs](https://find-sec-bugs.github.io) )è¿›è¡Œé™æ€å®‰å…¨åˆ†æã€‚å®ƒè¿˜å¯ä»¥ä½¿ç”¨ [GitLeaks](https://github.com/zricethezav/gitleaks) å®¡è®¡ä»“åº“ä¸­çš„ç§˜å¯†ï¼Œå¦‚ AWS ç§˜å¯†å¯†é’¥ã€ç§æœ‰ SSH å¯†é’¥å’Œè®¸å¤šå…¶ä»–ç§˜å¯†ã€‚

![](img//2413a6907ed6e23a06485d2b3b0ea197.png)

å®ƒæ˜¯å¦‚ä½•å·¥ä½œçš„ï¼Ÿ

å¼€å‘äººå‘˜å¯ä»¥åœ¨å…¶ CI æ¸ é“ä¸­è®¾ç½®ä¸€ä¸ªæ–°çš„é˜¶æ®µæ¥æ£€æŸ¥æ¼æ´:

![](img//05b680fab91c47b5b75e95e2042667e9.png)

**åˆå¿µâ€”â€”[è‡ªåŠ¨ API æ”»å‡»å·¥å…· 2019](https://kalilinuxtutorials.com/automatic-api-attack-tool/)**

**å®‰è£…**

**MongoDB**

ä½¿ç”¨æ‚¨æƒ³è¦çš„æ“ä½œç³»ç»Ÿ/é…ç½®è®¾ç½®ä¸€ä¸ª MongoDB(æœ€å¥½æ˜¯å®‰å…¨çš„)ã€‚

**ç å¤´ API(ç™¾æ¡æŒ‡ä»¤)**

**å®‰è£…åç«™ API:**

*   å®‰è£… **`docker-engine`** :

**yum install docker-engine**

*   åˆ›å»º docker æœåŠ¡æ–‡ä»¶å¤¹:

**mkdir/etc/system/dock . service . d**

*   å°†è¿™äº›é…ç½®è®¾ç½®åˆ° override.conf ä¸­:

**æˆ‘æ¥/etc/system/dock . service . d/override . conf**

*   å°†æ­¤å†…å®¹æ·»åŠ åˆ° override.conf:

**[Service]ExecStart = ExecStart =/usr/bin/dockerd-H FD://-H TCP://0 . 0 . 0 . 0:2376**

*   Reload daemon:

**systemctl daemon-reload**

*   é‡å¯ docker:

**systemctl é‡å¯ docker.service**

*   æœ¬åœ°æµ‹è¯• docker API:

**curl localhost:2376/v 1.24/version**

**ä¿æŠ¤æ‚¨çš„ Docker API(æ¨è):**

*   åˆ›å»ºè¯ä¹¦æ–‡ä»¶å¤¹:

**mkdir/data/certs&CD/data/certs**

ä»ä¸­ä¸‹è½½`**create-certs.sh**`è„šæœ¬:

**wget https://raw . githubusercontent . com/globo com/huskyCI/master/deployments/scripts/create-certs . sh**

ä½¿ç”¨è¯ä¹¦ä¿¡æ¯è®¾ç½®ç¯å¢ƒå˜é‡:

echo ' export CERT _ pass phrase = " my password $ RANDOM " ' >ã€‚env
echo ' export CERT _ DOCKER _ API _ HOST = " address . to . DOCKER API . HOST " '>>ã€‚env
echo ' export CERT _ HUSKYCI _ HOST = " address . to . HUSKYCI . HOST " '>>ã€‚åŒ…å°/åŒ…å›´ï¼ˆåŠ¨è¯ envelop çš„ç®€å†™ï¼‰

**ã€‚ã€‚ç¯å¢ƒ**

*   åˆ›å»º CA è¯ä¹¦:

**ã€‚/create-certs . sh-m ca-pw $ CERT _ pass phrase-t .-e 900**

*   åˆ›å»º docker API æœåŠ¡å™¨è¯ä¹¦:

**ã€‚/create-certs . sh-m server-hï¼„CERT _ DOCKER _ API _ HOST-pwï¼„CERT _ pass phrase-t .-e 365**

*   åˆ›å»º docker API å®¢æˆ·ç«¯è¯ä¹¦:

**ã€‚/create-certs . sh-m client-hï¼„CERT _ husky ci _ HOST-pwï¼„CERT _ pass phrase-t .-e 365**

*   æ›´æ–° override.conf é…ç½®:

**æˆ‘æ¥/etc/system/dock . service . d/override . conf**

*   å°†æ­¤æ–°å†…å®¹æ·»åŠ åˆ° override.conf:

**[Service]ExecStart =/usr/bin/dockerdâ€“TLS verifyâ€“tlscacert =/data/certs/ca . PEMâ€“TLS cert =/data/certs/server-cert . PEMâ€“TLS key =/data/certs/server-key . PEM-H FD://-H TCP://0 . 0 . 0 . 0:2376**

*   Reload daemon:

**systemctl daemon-reload**

*   é‡å¯ docker:

**systemctl é‡å¯ docker.service**

*   åœ¨æœ¬åœ°æµ‹è¯•å®‰å…¨ docker API:

**curl-k https://localhost:2376/v 1.24/versionâ€“cert/data/certs/client-cert . PEMâ€“key/data/certs/client-key . PEMâ€“cacert/data/certs/ca . PEM**

æ‚¨ç°åœ¨éœ€è¦ä¿å­˜ **`ca.pem`ã€`client-key.pem`** å’Œ`**client-cert.pem**`ä»¥ä¾¿åœ¨å®ƒçš„ä¸»æœºä¸­ä½¿ç”¨ï¼Œè¿™æ ·å®ƒå°±å¯ä»¥å®‰å…¨åœ°è¿æ¥åˆ° docker APIï¼ğŸ”’

**æ‹‰åŠ¨å›¾åƒ**

è®¾ç½® Docker API åï¼Œæ‚¨å¯ä»¥å°† [huskyCI å›¾åƒ](https://hub.docker.com/u/huskyci)æ”¾å…¥è¯¥ä¸»æœºï¼Œæˆ–è€…è®©å®ƒåœ¨æ”¶åˆ°ç¬¬ä¸€ä¸ªè¯·æ±‚æ—¶è‡ªåŠ¨æ‰§è¡Œæ­¤æ“ä½œ(å¯èƒ½éœ€è¦ä¸€äº›æ—¶é—´)ã€‚å¦‚æœæ‚¨å–œæ¬¢ç¬¬ä¸€ç§ç­–ç•¥ï¼Œè¯·ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤:

**åç«™æ‹‰èƒ¡åŸºå¥‡/æ©é‡Œ
åç«™æ‹‰èƒ¡åŸºå¥‡/åœŸåŒª
åç«™æ‹‰èƒ¡åŸºå¥‡/å®‰å…¨
åç«™æ‹‰èƒ¡åŸºå¥‡/å¸ƒæ‹‰å‡¯æ›¼
åç«™æ‹‰èƒ¡åŸºå¥‡/æˆˆæ–¯ ec
åç«™æ‹‰èƒ¡åŸºå¥‡/æ–¯é‚¦ç‰¹å¸ƒç“¦
åç«™æ‹‰èƒ¡åŸºå¥‡/npmaud**

**API ( [tsuru](https://github.com/tsuru/tsuru) PaaS æŒ‡ä»¤)**

*   è½¬åˆ°å·¥å…·æ–‡ä»¶å¤¹:

**CDï¼„GOPATH/src/github . com/globo com/huskyCI**

*   å°†ç”Ÿæˆçš„è¯ä¹¦å¤åˆ¶åˆ°`api`æ–‡ä»¶å¤¹:

**cp $MYCERTFOLDER/{ca.pemï¼Œclient-key.pemï¼Œclient-cert.pem} api/**

é‡å‘½å`**client-key.pem**`å’Œ`**client-cert.pem**`ï¼Œä»¥ä¾¿å®ƒåœ¨éƒ¨ç½²æ—¶å¯ä»¥è¯»å–æ­£ç¡®çš„æ–‡ä»¶:

**mv client-key . PEM key . PEM
mv client-cert . PEM cert . PEM**

*   æ„å»ºå®ƒ:

**è¿›è¡Œæ„å»º**

*   åˆ›å»ºæ–°çš„é¹¤åº”ç”¨ç¨‹åº:

**tsuru app-åˆ›å»º huskyCI go**

*   è®¾ç½®æ‰€æœ‰éœ€è¦çš„ç¯å¢ƒå˜é‡([å®Œæ•´åˆ—è¡¨](https://github.com/globocom/huskyci/wiki/API-Environment-Variables)):

**tsuru env-set MONGO _ HOST = urlto . MONGO . com-p**

å¦‚æœæ‚¨å¸Œæœ›å®ƒä½¿ç”¨ HTTPSï¼Œè¯·åœ¨éƒ¨ç½²ä¹‹å‰ç”Ÿæˆ`**api-tls-cert.pem**`å’Œ`**api-tls-key.pem**`ã€‚å¦å¤–ï¼Œæ‚¨åº”è¯¥å°†`**HUSKY_API_ENABLE_HTTPS**`ç¯å¢ƒå˜é‡è®¾ç½®ä¸º`**true**`ã€‚

*   å¦‚æœæ‚¨å†³å®šä½¿ç”¨ä¸Šé¢æåˆ°çš„ Docker API å®‰å…¨æ–¹æ³•ï¼Œæ‚¨éœ€è¦ä½¿ç”¨ä¸‹é¢çš„å‘½ä»¤è®¾ç½®è¿™äº›ç¯å¢ƒå˜é‡:

**tsuru env-set-p-a<my-app ' s-name>HUSKYCI _ docker API _ CERT _ FILE _ VALUE = " $(cat/path/to/my/FILE)"
tsuru env-set-p-a<my-app ' s-name>HUSKYCI _ docker API _ CERT _ KEY _ VALUE = " $(cat/path/to/my/FILE)"
tsuru env-set-p-a<my-app ' s-name**

*   åœ¨ tsuru (HTTP)ä¸­éƒ¨ç½²å®ƒ:

**tsuru app-deploy-a huskyCI API/huskyCI API/config . YAML proc file**

*   åœ¨é¹¤éƒ¨ç½²å®ƒ(HTTPS å·²å¯ç”¨):

**tsuru env-set-p-a<my-app ' s-name>HUSKYCI _ docker API _ API _ TLS _ CERT _ VALUE = " $(cat/path/to/my/file)"
tsuru env-set-p-a<my-app ' s-name>HUSKYCI _ docker API _ TLS _ KEY _ VALUE = " $(cat/path/to/my/file)"
tsuru app-deploy-a HUSKYCI API/HUSKYCI**

**å®¢æˆ·ç«¯( [tsuru](https://github.com/tsuru/tsuru) PaaS æŒ‡ä»¤)**

*   æœ¬åœ°æ„å»ºå®¢æˆ·ç«¯(Linux äºŒè¿›åˆ¶):

**åˆ¶ä½œ build-client-linux**

*   åˆ›å»ºé™æ€é¹¤åº”ç”¨ç¨‹åº:

**tsuru app-åˆ›å»º huskyCI-å®¢æˆ·ç«¯é™æ€**

*   åœ¨é¹¤éƒ¨ç½² it å®¢æˆ·ç«¯:

**tsuru app-deploy-a huskyCI-client huskyCI-client**

**å¼€å‘å•†çš„ CI**

æ³è¯·æ‚¨çš„å¼€å‘å›¢é˜Ÿåœ¨ä»–ä»¬çš„é¡¹ç›® CI ä¸­æ·»åŠ ä¸€ä¸ªæ–°é˜¶æ®µ(`**.gitlab-ci.yml**`ç¤ºä¾‹):

é˜¶æ®µ:
â€“husky ci
husky ci:
é˜¶æ®µ:huskyCI
å˜é‡:
husky ci _ CLIENT _ URL:http://URL to . husky ci-CLIENT
husky ci _ CLIENT _ API _ ADDR:http://URL to . husky ci-API
husky ci _ CLIENT _ REPO _ URL:git lab @ git labã€‚your org . com:$ CI _ PROJECT _ path . git
husky CI _ CLIENT _ REPO _ BRANCH:$ CI _ COMMIT _ REF _ NAME
husky CI _ CLIENT _ API _ USE _ HTTPS:" false "
è„šæœ¬:
â€“wget $ husky CI _ CLIENT _ URL/husky CI-CLIENT
â€“chmod+x husky CI-CLIENT
â€“/husky ci-å®¢æˆ·ç«¯

[**Download**](https://github.com/globocom/huskyCI)